# 模块结构

## 模块化设计

后端采用模块化设计,将不同功能领域划分为独立的模块,每个模块都有完整的分层结构。

## 模块总览

```
ruoyi-fastapi-backend/
├── module_admin/          # 核心管理模块
├── module_generator/      # 代码生成模块
└── module_task/          # 定时任务模块
```

## module_admin (核心管理模块)

这是系统的核心模块,包含所有业务功能。

### 目录结构

```
module_admin/
├── controller/           # 控制器层
│   ├── user_controller.py
│   ├── role_controller.py
│   ├── menu_controller.py
│   ├── dept_controller.py
│   ├── post_controller.py
│   ├── dict_controller.py
│   ├── config_controller.py
│   ├── notice_controller.py
│   ├── login_controller.py
│   ├── operlog_controller.py
│   ├── logininfor_controller.py
│   ├── project_controller.py
│   ├── protocol_controller.py
│   ├── device_controller.py
│   └── ...
│
├── service/             # 业务逻辑层
│   ├── user_service.py
│   ├── role_service.py
│   ├── menu_service.py
│   ├── dept_service.py
│   ├── login_service.py
│   ├── project_service.py
│   ├── protocol_service.py
│   └── ...
│
├── dao/                 # 数据访问层
│   ├── user_dao.py
│   ├── role_dao.py
│   ├── menu_dao.py
│   ├── dept_dao.py
│   ├── project_dao.py
│   ├── protocol_dao.py
│   └── ...
│
├── entity/              # 实体层
│   ├── do/             # 数据库对象
│   │   ├── user_do.py
│   │   ├── role_do.py
│   │   ├── menu_do.py
│   │   ├── dept_do.py
│   │   ├── project_do.py
│   │   ├── protocol_do.py
│   │   └── ...
│   └── vo/             # 视图对象
│       ├── user_vo.py
│       ├── role_vo.py
│       ├── menu_vo.py
│       ├── project_vo.py
│       ├── protocol_vo.py
│       └── ...
│
├── aspect/              # 切面
│   ├── interface_auth.py      # 接口权限验证
│   ├── data_scope.py          # 数据权限
│   └── log_aspect.py          # 日志切面
│
└── annotation/          # 注解/装饰器
    ├── log_annotation.py      # 日志注解
    └── data_scope_annotation.py
```

### 功能子模块

#### 1. 用户管理 (User)
**文件**: `user_controller.py`, `user_service.py`, `user_dao.py`

**功能**:
- 用户 CRUD 操作
- 用户角色分配
- 密码管理
- 用户状态管理

**API 端点**:
- `GET /system/user/list` - 用户列表
- `GET /system/user/{user_id}` - 用户详情
- `POST /system/user` - 新增用户
- `PUT /system/user` - 修改用户
- `DELETE /system/user/{user_id}` - 删除用户
- `PUT /system/user/resetPwd` - 重置密码

#### 2. 角色管理 (Role)
**文件**: `role_controller.py`, `role_service.py`, `role_dao.py`

**功能**:
- 角色 CRUD 操作
- 角色权限分配
- 数据权限配置

**API 端点**:
- `GET /system/role/list` - 角色列表
- `POST /system/role` - 新增角色
- `PUT /system/role` - 修改角色
- `PUT /system/role/dataScope` - 数据权限

#### 3. 菜单管理 (Menu)
**文件**: `menu_controller.py`, `menu_service.py`, `menu_dao.py`

**功能**:
- 菜单树形结构
- 权限标识管理
- 路由配置

**API 端点**:
- `GET /system/menu/list` - 菜单列表
- `GET /system/menu/treeselect` - 菜单树
- `POST /system/menu` - 新增菜单

#### 4. 部门管理 (Dept)
**文件**: `dept_controller.py`, `dept_service.py`, `dept_dao.py`

**功能**:
- 部门树形结构
- 组织架构管理

**API 端点**:
- `GET /system/dept/list` - 部门列表
- `GET /system/dept/treeselect` - 部门树
- `POST /system/dept` - 新增部门

#### 5. 字典管理 (Dict)
**文件**: `dict_controller.py`, `dict_service.py`, `dict_dao.py`

**功能**:
- 字典类型管理
- 字典数据管理
- 缓存刷新

#### 6. 参数配置 (Config)
**文件**: `config_controller.py`, `config_service.py`, `config_dao.py`

**功能**:
- 系统参数配置
- 参数缓存

#### 7. 通知公告 (Notice)
**文件**: `notice_controller.py`, `notice_service.py`, `notice_dao.py`

**功能**:
- 公告发布
- 公告查询

#### 8. 登录认证 (Login)
**文件**: `login_controller.py`, `login_service.py`

**功能**:
- 用户登录
- Token 生成
- 验证码
- 登出

#### 9. 操作日志 (OperLog)
**文件**: `operlog_controller.py`, `operlog_service.py`, `operlog_dao.py`

**功能**:
- 操作日志记录
- 日志查询
- 日志导出

#### 10. 登录日志 (LoginInfor)
**文件**: `logininfor_controller.py`, `logininfor_service.py`, `logininfor_dao.py`

**功能**:
- 登录日志记录
- 登录统计

#### 11. 项目管理 (Project)
**文件**: `project_controller.py`, `project_service.py`, `project_dao.py`

**功能**:
- 项目 CRUD
- 项目版本管理
- 项目拓扑

#### 12. 协议管理 (Protocol)
**文件**: `protocol_controller.py`, `protocol_service.py`, `protocol_dao.py`

**功能**:
- 协议配置
- 协议类型管理

#### 13. 设备管理 (Device)
**文件**: `device_controller.py`, `device_service.py`, `device_dao.py`

**功能**:
- 设备 CRUD
- 设备分类

### 切面模块 (Aspect)

#### 1. 接口权限验证 (interface_auth.py)
```python
class CheckUserInterfaceAuth:
    """
    检查用户接口权限
    """
    def __init__(self, perms: str):
        self.perms = perms
    
    async def __call__(self, request: Request, ...):
        # 验证用户是否有指定权限
        if not has_permission(user, self.perms):
            raise PermissionException()
```

**使用方式**:
```python
@router.get("/list", dependencies=[Depends(CheckUserInterfaceAuth("system:user:list"))])
async def get_user_list(...):
    pass
```

#### 2. 数据权限 (data_scope.py)
```python
class GetDataScope:
    """
    获取数据权限范围
    """
    async def __call__(self, request: Request, ...):
        # 根据用户角色返回数据权限SQL
        return data_scope_sql
```

#### 3. 日志切面 (log_aspect.py)
自动记录操作日志

### 注解模块 (Annotation)

#### 1. 日志注解 (log_annotation.py)
```python
class Log:
    """
    操作日志注解
    """
    def __init__(self, title: str, business_type: int):
        self.title = title
        self.business_type = business_type
```

**使用方式**:
```python
@Log(title="用户管理", business_type=2)
async def add_user(...):
    pass
```

## module_generator (代码生成模块)

### 目录结构

```
module_generator/
├── controller/
│   └── gen_controller.py
├── service/
│   └── gen_service.py
├── dao/
│   └── gen_dao.py
└── templates/           # 代码模板
    ├── python/
    │   ├── controller.py.jinja2
    │   ├── service.py.jinja2
    │   ├── dao.py.jinja2
    │   ├── do.py.jinja2
    │   └── vo.py.jinja2
    └── vue/
        ├── index.vue.jinja2
        └── api.js.jinja2
```

### 功能
- 数据库表结构读取
- 代码模板渲染
- 前后端代码生成
- 批量生成

## module_task (定时任务模块)

### 目录结构

```
module_task/
├── controller/
│   └── job_controller.py
├── service/
│   └── job_service.py
├── dao/
│   └── job_dao.py
└── scheduler/
    └── task_scheduler.py
```

### 功能
- 任务 CRUD
- 任务调度
- 任务执行日志
- Cron 表达式支持

## 公共模块

### config/ (配置模块)

```
config/
├── database.py          # 数据库配置
├── env.py              # 环境变量
├── get_db.py           # 数据库依赖
├── get_redis.py        # Redis 依赖
├── constant.py         # 常量定义
└── enums.py            # 枚举定义
```

### middlewares/ (中间件)

```
middlewares/
├── cors_middleware.py       # CORS 跨域
├── gzip_middleware.py       # Gzip 压缩
└── trace_middleware/        # 请求追踪
```

### exceptions/ (异常处理)

```
exceptions/
├── exception.py        # 自定义异常
└── handle.py          # 异常处理器
```

### utils/ (工具类)

```
utils/
├── common_util.py      # 通用工具
├── response_util.py    # 响应工具
├── log_util.py         # 日志工具
├── pwd_util.py         # 密码工具
├── jwt_util.py         # JWT 工具
├── redis_util.py       # Redis 工具
└── ...
```

## 模块开发规范

### 1. 新增功能模块

创建一个新的功能模块(例如:商品管理):

```
module_admin/
├── controller/
│   └── goods_controller.py      # 1. 创建控制器
├── service/
│   └── goods_service.py          # 2. 创建服务
├── dao/
│   └── goods_dao.py              # 3. 创建 DAO
└── entity/
    ├── do/
    │   └── goods_do.py           # 4. 创建 DO 模型
    └── vo/
        └── goods_vo.py           # 5. 创建 VO 模型
```

### 2. 模块命名规范

- Controller: `{模块名}_controller.py`
- Service: `{模块名}_service.py`
- DAO: `{模块名}_dao.py`
- DO: `{模块名}_do.py`
- VO: `{模块名}_vo.py`

### 3. 路由前缀规范

- 系统模块: `/system/{模块名}`
- 业务模块: `/{业务域}/{模块名}`
- 监控模块: `/monitor/{模块名}`
- 工具模块: `/tool/{模块名}`

### 4. 权限标识规范

格式: `{模块}:{功能}:{操作}`

示例:
- `system:user:list` - 用户列表查询
- `system:user:add` - 用户新增
- `system:user:edit` - 用户修改
- `system:user:remove` - 用户删除
- `system:user:export` - 用户导出

## 模块间依赖

### 依赖原则
- 业务模块可以依赖公共模块
- 业务模块之间尽量解耦
- 通过 Service 层调用其他模块

### 示例
```python
class ProjectService:
    def __init__(self, db: AsyncSession = Depends(get_db)):
        self.db = db
        self.project_dao = ProjectDao(db)
        # 依赖其他模块的 Service
        self.user_service = UserService(db)
        self.dept_service = DeptService(db)
```

## 下一步

- [数据库设计](./04-数据库设计.md) - 查看数据库架构
- [API设计](./05-API设计.md) - 学习 API 开发规范
- [权限认证](./06-权限认证.md) - 理解权限系统
