# 后端系统概览

## 简介

RuoYi-Vue3-FastAPI 后端基于 FastAPI 构建,这是一个现代、高性能的 Python Web 框架。系统遵循清晰的分层架构模式,实现关注点分离。

## 核心架构原则

### 1. 分层架构
系统遵循严格的 4 层架构:
```
Controller 层 (API 端点)
    ↓
Service 层 (业务逻辑)
    ↓
DAO 层 (数据访问)
    ↓
Database 层 (MySQL/PostgreSQL)
```

### 2. 异步编程模式
所有数据库操作使用 SQLAlchemy 的异步能力,提供更好的性能和可扩展性。

### 3. 依赖注入
在整个系统中使用 FastAPI 的依赖注入系统:
- 数据库会话管理
- 认证和授权
- 请求上下文管理
- Redis 连接

### 4. 模块化设计
系统按功能模块组织:
- `module_admin`: 核心业务功能
- `module_generator`: 代码生成工具
- `module_task`: 定时任务管理

## 技术栈

### 核心框架
- **FastAPI 0.115.8**: 现代异步 Web 框架
- **Python 3.9+**: 编程语言
- **Uvicorn**: 生产环境 ASGI 服务器

### 数据库与 ORM
- **SQLAlchemy 2.0.38**: 异步 ORM 数据库操作
- **MySQL 5.7+** 或 **PostgreSQL**: 主数据库
- **Redis 5.2.1**: 缓存和会话存储

### 认证与安全
- **JWT**: 基于令牌的认证
- **OAuth2**: 认证流程
- **passlib + bcrypt**: 密码哈希

### 工具库
- **APScheduler 3.11.0**: 任务调度
- **Loguru 0.7.3**: 结构化日志
- **python-dotenv**: 环境配置
- **Pydantic**: 数据验证

## 项目结构

```
ruoyi-fastapi-backend/
├── app.py                    # 应用入口
├── server.py                 # FastAPI 应用配置
├── requirements.txt          # Python 依赖
├── .env.dev / .env.prod     # 环境配置
│
├── config/                   # 配置模块
│   ├── database.py          # 数据库连接配置
│   ├── env.py              # 环境变量加载
│   ├── get_db.py           # 数据库依赖
│   ├── get_redis.py        # Redis 依赖
│   ├── constant.py         # 系统常量
│   └── enums.py            # 枚举定义
│
├── module_admin/            # 主业务模块
│   ├── controller/         # API 端点 (FastAPI 路由)
│   ├── service/           # 业务逻辑层
│   ├── dao/               # 数据访问层
│   ├── entity/            # 数据模型
│   │   ├── do/           # 数据库对象 (SQLAlchemy)
│   │   └── vo/           # 视图对象 (Pydantic)
│   ├── aspect/           # 切面关注点
│   └── annotation/       # 装饰器
│
├── middlewares/            # FastAPI 中间件
│   ├── cors_middleware.py
│   ├── gzip_middleware.py
│   └── trace_middleware/
│
├── exceptions/             # 异常处理
│   ├── exception.py       # 自定义异常
│   └── handle.py          # 异常处理器
│
├── utils/                  # 工具函数
│   ├── common_util.py
│   ├── response_util.py
│   ├── log_util.py
│   └── ...
│
└── sql/                    # 数据库脚本
    ├── ruoyi-fastapi.sql  # MySQL 脚本
    └── ruoyi-fastapi-pg.sql # PostgreSQL 脚本
```

## 核心功能

### 1. 权限系统
- 基于角色的访问控制 (RBAC)
- 菜单级权限
- 按钮级权限
- 数据权限(行级安全)

### 2. 操作日志
- 自动记录所有操作
- 登录/登出追踪
- 合规审计追踪

### 3. 多租户支持
- 数据范围隔离
- 基于部门的数据过滤
- 用户级数据访问控制

### 4. 缓存策略
- 基于 Redis 的缓存
- 字典数据缓存
- 用户会话管理
- Token 存储

### 5. 任务调度
- APScheduler 集成
- 基于 Cron 的调度
- 任务执行日志
- 动态任务管理

## 请求流程

```
1. HTTP 请求
   ↓
2. 中间件层
   - CORS 处理
   - 请求追踪
   - Gzip 压缩
   ↓
3. Controller 层
   - 路由匹配
   - 请求验证 (Pydantic)
   - 权限检查
   ↓
4. Service 层
   - 业务逻辑执行
   - 事务管理
   - 数据验证
   ↓
5. DAO 层
   - 数据库查询 (异步)
   - 数据映射
   ↓
6. 数据库
   - MySQL/PostgreSQL
   ↓
7. 响应
   - 数据序列化
   - 响应格式化
   - 错误处理
```

## 配置管理

### 环境文件
- `.env.dev`: 开发环境配置
- `.env.prod`: 生产环境配置

### 主要配置项
- 数据库连接字符串
- Redis 连接
- JWT 密钥
- 文件上传路径
- CORS 设置
- 日志级别

## 开发命令

```bash
# 进入后端目录
cd ruoyi-fastapi-backend

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate  # macOS/Linux

# 安装依赖
pip install -r requirements.txt

# 运行开发服务器
python app.py --env=dev

# 使用自动重载运行
uvicorn server:app --reload --host 0.0.0.0 --port 8000
```

## API 文档

FastAPI 自动生成交互式 API 文档:
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

## 下一步

- [分层架构](./02-分层架构.md) - 理解分层模式
- [模块结构](./03-模块结构.md) - 学习模块组织
- [数据库设计](./04-数据库设计.md) - 查看数据库架构
- [API设计](./05-API设计.md) - API 开发模式
- [权限认证](./06-权限认证.md) - 安全实现
- [开发规范](./07-开发规范.md) - 编码标准
