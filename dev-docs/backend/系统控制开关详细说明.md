# RuoYi-FastAPI 系统控制开关详细说明

## 文档概述

本文档专门介绍 RuoYi-FastAPI 后端系统中所有功能控制开关、业务配置项和系统行为控制参数的详细说明，帮助开发者和运维人员精确控制系统功能。

---

## 1. 核心功能控制开关

### 1.1 用户登录控制开关

#### 同账号多地登录控制
**配置位置**: `config/env.py` -> `AppSettings.app_same_time_login`

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `app_same_time_login` | bool | `True` | 控制同一账号是否允许在多个地方同时登录 |

**详细说明**:
- `True`: 允许同一账号在不同设备/地点同时登录
- `False`: 同一账号只能在一个地方登录，后登录会踢掉先登录的会话

**实现机制**:
```python
if AppConfig.app_same_time_login:
    # 使用 session_id 作为 Redis key，允许多会话
    redis_key = f'access_token:{session_id}'
else:
    # 使用 user_id 作为 Redis key，同一用户只能有一个会话
    redis_key = f'access_token:{user_id}'
```

**使用场景**:
- 企业内部系统：建议设为 `False`，确保账号安全
- 个人应用/多设备场景：可设为 `True`，提供便利性

#### IP地址归属地查询控制
**配置位置**: `config/env.py` -> `AppSettings.app_ip_location_query`

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `app_ip_location_query` | bool | `True` | 是否启用用户登录IP地址归属地查询 |

**功能影响**:
- `True`: 在登录日志中显示具体的地理位置信息
- `False`: 仅显示IP地址，不进行地理位置解析

### 1.2 系统配置开关 (数据库配置)

#### 验证码功能控制
**配置位置**: 数据库 `sys_config` 表
**配置键**: `sys.account.captchaEnabled`

| 配置值 | 说明 | 影响功能 |
|--------|------|----------|
| `'true'` | 启用验证码 | 登录、注册需要输入验证码 |
| `'false'` | 禁用验证码 | 不需要验证码验证 |

**代码实现**:
```python
captcha_enabled = (
    True if await redis.get('sys_config:sys.account.captchaEnabled') == 'true'
    else False
)
```

#### 用户注册功能控制
**配置位置**: 数据库 `sys_config` 表
**配置键**: `sys.account.registerUser`

| 配置值 | 说明 | 影响功能 |
|--------|------|----------|
| `'true'` | 允许用户注册 | 开放用户自主注册功能 |
| `'false'` | 禁止用户注册 | 关闭注册入口，仅管理员可创建账号 |

#### 登录IP黑名单控制
**配置位置**: 数据库 `sys_config` 表
**配置键**: `sys.login.blackIPList`

**配置格式**:
```
# 支持多种格式，用分号分隔
192.168.1.*;10.0.0.0/24;172.16.100.50
```

**支持的匹配模式**:
- 通配符: `192.168.1.*`
- 网段: `10.0.0.0/24`
- 精确IP: `172.16.100.50`

---

## 2. 数据库行为控制

### 2.1 数据库类型切换
**配置位置**: `config/env.py` -> `DataBaseSettings.db_type`

| 参数值 | 说明 | 依赖包 |
|--------|------|--------|
| `'mysql'` | 使用MySQL数据库 | `requirements.txt` |
| `'postgresql'` | 使用PostgreSQL数据库 | `requirements-pg.txt` |

**影响系统行为**:
- SQL方言自动适配
- 数据类型映射自动切换
- 连接驱动自动选择

### 2.2 数据库调试控制
**配置位置**: `config/env.py` -> `DataBaseSettings.db_echo`

| 参数值 | 说明 | 适用环境 |
|--------|------|----------|
| `True` | 输出所有SQL语句到日志 | 开发、调试环境 |
| `False` | 不输出SQL语句 | 生产环境 |

### 2.3 连接池行为控制

| 参数 | 默认值 | 说明 | 调优建议 |
|------|--------|------|----------|
| `db_pool_size` | 50 | 连接池基础大小 | 根据并发量调整 |
| `db_max_overflow` | 10 | 最大溢出连接数 | 不超过数据库最大连接数 |
| `db_pool_recycle` | 3600 | 连接回收时间(秒) | MySQL: 3600, PostgreSQL: 7200 |
| `db_pool_timeout` | 30 | 获取连接超时时间(秒) | 高并发环境可适当增加 |

---

## 3. 文件处理控制

### 3.1 文件上传限制控制

#### 允许的文件类型
**配置位置**: `config/env.py` -> `UploadSettings.DEFAULT_ALLOWED_EXTENSION`

**分类配置**:
```python
# 图片类型
IMAGE_TYPES = ['bmp', 'gif', 'jpg', 'jpeg', 'png']

# 文档类型  
DOCUMENT_TYPES = ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'pdf', 'txt']

# 压缩文件
ARCHIVE_TYPES = ['rar', 'zip', 'gz', 'bz2']

# 视频文件
VIDEO_TYPES = ['mp4', 'avi', 'rmvb']
```

#### 上传路径控制
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `UPLOAD_PREFIX` | `/profile` | 文件访问URL前缀 |
| `UPLOAD_PATH` | `vf_admin/upload_path` | 文件存储物理路径 |
| `DOWNLOAD_PATH` | `vf_admin/download_path` | 导出文件临时路径 |

---

## 4. 定时任务安全控制

### 4.1 任务执行白名单
**配置位置**: `config/constant.py` -> `JobConstant.JOB_WHITE_LIST`

```python
JOB_WHITE_LIST = ['module_task']
```

**说明**: 只有在白名单模块中的任务才允许被定时调度执行。

### 4.2 任务执行黑名单
**配置位置**: `config/constant.py` -> `JobConstant.JOB_ERROR_LIST`

**禁止的模块和字符**:
```python
JOB_ERROR_LIST = [
    # 系统核心模块（防止恶意调用）
    'app', 'config', 'exceptions', 'middlewares', 'module_admin',
    'server', 'sub_applications', 'utils',
    
    # 危险函数
    'import ', 'open(', 'os.', 'subprocess.', 'sys.', '__import__',
    
    # 危险字符
    '"', "'", ',', '?', ':', ';', '/', '|', '+', '-', '=', '~', '!',
    '#', '$', '%', '^', '&', '*', '<', '>', '(', ')', '[', ']', 
    '{', '}', ' '
]
```

---

## 5. 权限控制开关

### 5.1 菜单权限控制

#### 菜单类型定义
**配置位置**: `config/constant.py` -> `MenuConstant`

| 类型 | 代码 | 说明 |
|------|------|------|
| 目录 | `'M'` | 菜单目录，用于组织菜单结构 |
| 菜单 | `'C'` | 具体的菜单项，对应页面 |
| 按钮 | `'F'` | 页面内的功能按钮权限 |

#### 菜单外链控制
| 配置 | 值 | 说明 |
|------|-----|------|
| `YES_FRAME` | 0 | 菜单为外链形式 |
| `NO_FRAME` | 1 | 菜单为内部页面 |

#### 菜单组件标识
| 标识 | 说明 | 用途 |
|------|------|------|
| `Layout` | 布局组件 | 顶级菜单的默认组件 |
| `ParentView` | 父级视图 | 有子菜单的中间层组件 |
| `InnerLink` | 内嵌链接 | 内嵌外部链接的组件 |

### 5.2 数据权限控制

#### 部门状态控制
**配置位置**: `config/constant.py` -> `CommonConstant`

| 状态 | 代码 | 说明 |
|------|------|------|
| 正常 | `'0'` | 部门正常状态，用户可见 |
| 停用 | `'1'` | 部门停用状态，用户不可见 |

#### 系统默认标识
| 标识 | 值 | 说明 |
|------|-----|------|
| `YES` | `'Y'` | 是系统默认/内置数据 |
| `NO` | `'N'` | 非系统默认数据 |

---

## 6. 代码生成控制

### 6.1 生成模板控制
**配置位置**: `config/constant.py` -> `GenConstant`

| 模板类型 | 代码 | 说明 |
|----------|------|------|
| 单表CRUD | `'crud'` | 标准的增删改查功能 |
| 树形表 | `'tree'` | 树形结构的数据管理 |
| 主子表 | `'sub'` | 主表与子表关联的数据结构 |

### 6.2 字段生成控制

#### 页面显示控制
```python
# 不在新增页面显示的字段
COLUMNNAME_NOT_ADD_SHOW = ['create_by', 'create_time']

# 不在编辑页面显示的字段  
COLUMNNAME_NOT_EDIT_SHOW = ['update_by', 'update_time']

# 不允许编辑的字段
COLUMNNAME_NOT_EDIT = ['id', 'create_by', 'create_time', 'del_flag']

# 不在列表显示的字段
COLUMNNAME_NOT_LIST = ['id', 'create_by', 'create_time', 'del_flag', 'update_by', 'update_time']

# 不作为查询条件的字段
COLUMNNAME_NOT_QUERY = ['id', 'create_by', 'create_time', 'del_flag', 'update_by', 'update_time', 'remark']
```

#### 表单控件类型
| 控件类型 | 代码 | 适用场景 |
|----------|------|----------|
| 文本框 | `'input'` | 普通文本输入 |
| 文本域 | `'textarea'` | 多行文本输入 |
| 下拉框 | `'select'` | 选择类数据 |
| 单选框 | `'radio'` | 二选一或多选一 |
| 复选框 | `'checkbox'` | 多选场景 |
| 日期控件 | `'datetime'` | 日期时间选择 |
| 图片上传 | `'imageUpload'` | 图片文件上传 |
| 文件上传 | `'fileUpload'` | 普通文件上传 |
| 富文本 | `'editor'` | 富文本内容编辑 |

---

## 7. 日志控制开关

### 7.1 操作日志控制
**使用方式**: 通过装饰器 `@Log()` 控制

```python
@Log(
    title='用户管理',           # 日志标题
    business_type=BusinessType.INSERT,  # 业务类型
    log_type='operation'       # 日志类型，可选
)
```

#### 业务类型定义
| 类型 | 代码 | 说明 |
|------|------|------|
| 其它 | 0 | 默认类型 |
| 新增 | 1 | 新增操作 |
| 修改 | 2 | 修改操作 |
| 删除 | 3 | 删除操作 |
| 授权 | 4 | 权限授权操作 |
| 导出 | 5 | 数据导出操作 |
| 导入 | 6 | 数据导入操作 |
| 强退 | 7 | 强制下线操作 |
| 生成代码 | 8 | 代码生成操作 |
| 清空数据 | 9 | 数据清空操作 |

### 7.2 登录日志控制
**特殊配置**: `log_type='login'`

```python
@Log(
    title='用户登录',
    business_type=BusinessType.OTHER,
    log_type='login'  # 特殊标识，记录登录相关信息
)
```

**额外记录信息**:
- 登录IP地址
- 地理位置（如果启用）
- 浏览器信息
- 操作系统信息
- 登录时间

---

## 8. 缓存控制策略

### 8.1 Redis缓存键管理
**配置位置**: `config/enums.py` -> `RedisInitKeyConfig`

| 缓存类型 | 键名 | 过期策略 | 用途 |
|----------|------|----------|------|
| 访问令牌 | `access_token` | JWT过期时间 | 用户会话管理 |
| 系统字典 | `sys_dict` | 手动刷新 | 字典数据缓存 |
| 系统配置 | `sys_config` | 手动刷新 | 配置参数缓存 |
| 验证码 | `captcha_codes` | 5分钟 | 图片验证码存储 |
| 账号锁定 | `account_lock` | 24小时 | 账号锁定状态 |
| 密码错误 | `password_error_count` | 24小时 | 密码错误次数统计 |
| 短信验证码 | `sms_code` | 5分钟 | 短信验证码存储 |

### 8.2 缓存刷新控制

#### 手动刷新接口
```python
# 刷新字典缓存
POST /system/dict/data/refreshCache

# 刷新配置缓存  
DELETE /system/config/refreshCache
```

#### 自动刷新机制
- 字典数据修改时自动刷新相关缓存
- 配置参数修改时自动刷新配置缓存
- 用户权限变更时自动清理用户相关缓存

---

## 9. 系统行为控制最佳实践

### 9.1 安全相关配置建议

#### 生产环境必须配置
```env
# 禁止同时登录
APP_SAME_TIME_LOGIN=false

# 启用验证码
sys.account.captchaEnabled=true

# 禁止自主注册
sys.account.registerUser=false

# 配置IP黑名单
sys.login.blackIPList=恶意IP列表

# 禁用SQL日志
DB_ECHO=false

# 禁用热重载
APP_RELOAD=false
```

#### 开发环境推荐配置
```env
# 允许同时登录（便于调试）
APP_SAME_TIME_LOGIN=true

# 可选择性启用验证码
sys.account.captchaEnabled=false

# 启用SQL日志（便于调试）
DB_ECHO=true

# 启用热重载
APP_RELOAD=true
```

### 9.2 性能优化配置建议

#### 高并发环境
```env
# 增大连接池
DB_POOL_SIZE=100
DB_MAX_OVERFLOW=50

# 调整JWT过期时间
JWT_EXPIRE_MINUTES=480
JWT_REDIS_EXPIRE_MINUTES=30

# 禁用IP地理查询（减少外部API调用）
APP_IP_LOCATION_QUERY=false
```

#### 低配置环境
```env
# 减小连接池
DB_POOL_SIZE=10
DB_MAX_OVERFLOW=5

# 延长连接回收时间
DB_POOL_RECYCLE=7200
```

### 9.3 功能开关组合建议

#### 企业内网环境
```env
APP_SAME_TIME_LOGIN=false          # 安全第一
APP_IP_LOCATION_QUERY=false        # 内网不需要
sys.account.captchaEnabled=true    # 提高安全性
sys.account.registerUser=false     # 统一管理账号
```

#### 公网SaaS环境
```env  
APP_SAME_TIME_LOGIN=true           # 用户体验
APP_IP_LOCATION_QUERY=true         # 安全监控
sys.account.captchaEnabled=true    # 防止恶意注册
sys.account.registerUser=true      # 允许自主注册
```

#### 开发测试环境
```env
APP_SAME_TIME_LOGIN=true           # 便于测试
APP_IP_LOCATION_QUERY=false        # 减少依赖
sys.account.captchaEnabled=false   # 便于自动化测试
sys.account.registerUser=true      # 便于创建测试账号
```

---

## 10. 故障排除指南

### 10.1 常见开关配置问题

#### 同时登录控制不生效
**排查步骤**:
1. 确认 `APP_SAME_TIME_LOGIN` 配置值
2. 检查Redis连接状态
3. 查看token存储的key格式
4. 确认配置重启后生效

#### 验证码功能异常
**排查步骤**:
1. 检查数据库中 `sys_config` 表的配置
2. 确认Redis中的配置缓存
3. 验证验证码生成和验证逻辑
4. 检查前端验证码组件

#### 文件上传失败
**排查步骤**:
1. 确认文件类型是否在允许列表中
2. 检查上传路径是否存在且有写权限
3. 验证文件大小限制
4. 查看具体错误日志

### 10.2 性能问题排查

#### 数据库连接池耗尽
**症状**: 获取数据库连接超时
**解决方案**:
```env
# 增加连接池配置
DB_POOL_SIZE=100
DB_MAX_OVERFLOW=50
DB_POOL_TIMEOUT=60
```

#### Redis连接异常
**症状**: 缓存功能失效，登录状态丢失
**解决方案**:
1. 检查Redis服务状态
2. 验证Redis连接配置
3. 查看Redis连接日志

---

## 总结

本文档详细介绍了 RuoYi-FastAPI 后端系统中所有的控制开关和配置选项，包括：

- **功能开关**: 登录控制、验证码开关、注册开关等
- **性能控制**: 数据库连接池、缓存策略等  
- **安全控制**: IP黑名单、权限控制、文件上传限制等
- **行为控制**: 日志记录、任务调度、代码生成等

通过合理配置这些开关，可以精确控制系统功能，满足不同场景下的业务需求。

---

**文档版本**: v1.0  
**更新时间**: 2024年12月  
**维护人员**: Development Team