## 场景与现象

- **场景**: 本地按照项目 `README.md` / `QUICK_START.md` 说明，通过 `./setup.sh` 和 `./start.sh` 启动项目后，访问前端登录页。
- **现象**:
  - 登录页验证码图片无法加载，浏览器控制台提示后端接口异常。
  - 登录提交也无法成功。
  - 终端和日志中出现数据库相关错误或“数据库连接失败，请先运行 ./setup.sh”提示。

## 关键错误信息

- 在后端日志中出现：
  - `asyncmy.errors.OperationalError) (1045, "Access denied for user 'root'@'localhost' (using password: NO)")`
  - 含义：使用 MySQL 用户 `root` 连接时 **没有带密码**，被 MySQL 拒绝访问。
- 在执行 `./start.sh` 时，终端输出：
  - `❌ 数据库连接失败，请先运行 ./setup.sh`

这些错误共同指向：**后端实际使用的数据库账号密码配置与本地 MySQL 实际配置不一致**。

## 项目中与数据库相关的配置位置

- **后端配置**
  - `ruoyi-fastapi-backend/config/env.py`
    - `DataBaseSettings` 默认值：
      - `db_username: str = 'root'`
      - `db_password: str = 'mysqlroot'`（原始默认值）
    - 运行时会通过 `python-dotenv` 加载 `.env.dev` / `.env.{env}` 中的环境变量覆盖这些默认值。
  - `ruoyi-fastapi-backend/config/database.py`
    - 使用 `DataBaseConfig` 组装异步数据库连接串：
      - `mysql+asyncmy://{db_username}:{db_password}@{db_host}:{db_port}/{db_database}`

- **脚本与说明**
  - `setup.sh`
    - 默认假设 MySQL `root` 用户 **无密码**，通过 `mysql -u root` 创建和导入数据库：
      - 创建库：`mysql -u root -e "CREATE DATABASE IF NOT EXISTS \`ruoyi-fastapi\` ...;"`
      - 导入库：`mysql -u root ruoyi-fastapi < ruoyi-fastapi-backend/sql/ruoyi-fastapi.sql`
    - 尝试修改 `.env.dev` 中的数据库配置（假定存在该文件）。
  - `start.sh`
    - 在启动前用 `mysql -u root -e "USE \`ruoyi-fastapi\`; SELECT 1;"` 方式验证数据库连接（最初没有带密码）。

## 实际环境与配置不一致点

- 实际上，本地 MySQL 已为 `root` 用户设置了密码：
  - 手工执行以下命令可以成功访问数据库：
    - `mysql -u root -padmin1234 ruoyi-fastapi`
  - 说明当前生效的密码是：`admin1234`。
- 但项目代码和脚本中存在多个与之不一致的假设：
  - `env.py` 中数据库默认密码为 `mysqlroot`。
  - `setup.sh` 和原始环境配置假设 `root` 无密码，通过 `mysql -u root` 访问。
  - `.env.dev` 如果存在，有可能仍然保留旧密码或空密码配置。
- 综合结果：**后端进程启动时，实际连库时要么不带密码，要么带的是旧密码，从而触发 1045 拒绝访问**。

## 排查思路与过程

1. **确认数据库本身是否正常可用**
   - 在项目根目录执行：
     - `mysql -u root -padmin1234 -e "USE \`ruoyi-fastapi\`; SELECT 1;"`
   - 命令执行成功，说明：
     - MySQL 服务正常。
     - 数据库 `ruoyi-fastapi` 存在。
     - `root/admin1234` 是当前正确的账号密码。

2. **确认前端访问后端的地址与端口**
   - 查看 `ruoyi-fastapi-frontend/vite.config.ts`：
     - 代理后端地址为 `http://127.0.0.1:8000`。
   - 后端 `AppConfig` 中端口为 `8000`。
   - 说明前后端在端口配置上是一致的，问题不是端口错配。

3. **检查后端运行时使用的数据库配置**
   - 在虚拟环境中执行：
     - `cd ruoyi-fastapi-backend`
     - `source venv/bin/activate`
     - `python -c "from config.env import DataBaseConfig; print(DataBaseConfig.db_username, DataBaseConfig.db_password, DataBaseConfig.db_database)"`
   - 输出结果最初为：
     - `root mysqlroot ruoyi-fastapi` 或者 `root  ruoyi-fastapi`（密码为空）
   - 这与实际 `admin1234` 明显不一致，验证了错误根因：**后端使用了错误的数据库密码**。

4. **检查后端启动日志**
   - 查看 `ruoyi-fastapi-backend/logs/2025-11-15_error.log`，发现多次重复：
     - `RuoYi-FastAPI开始启动`
     - `初始化数据库连接...`
   - 结合终端出现的 `asyncmy.errors.OperationalError (1045)`，可以判断是：
     - 后端在启动生命周期（`lifespan`）阶段初始化数据库连接时，因密码错误而失败。
     - 导致启动流程异常，接口不可用（包括验证码接口）。

5. **检查启动脚本与自动化脚本**
   - `start.sh`：
     - 使用 `mysql -u root` 直接检查数据库，不带密码。
     - 当 MySQL 已配置密码时，此检查必然失败，输出：
       - `❌ 数据库连接失败，请先运行 ./setup.sh`
   - `setup.sh`：
     - 假定 MySQL 初始无密码，并尝试在 `.env.dev` 中将 `DB_PASSWORD` 改为某个值或空值。
     - 但实际环境中，用户后来手动将 MySQL root 改为了 `admin1234`，脚本逻辑与现状产生偏差。

综上，问题可以归纳为：**MySQL root 密码从默认假设状态被手动改成了 `admin1234`，而项目配置与脚本仍按照“无密码”或“旧密码”在连接数据库，导致后端启动阶段连接失败，进而使验证码与登录接口不可用。**

## 最终修复方案

### 1. 统一后端数据库配置为当前实际密码

- 修改 `ruoyi-fastapi-backend/config/env.py` 中 `DataBaseSettings` 默认配置，将数据库密码更新为实际使用的密码：

```python
class DataBaseSettings(BaseSettings):
    """
    数据库配置
    """

    db_type: Literal['mysql', 'postgresql'] = 'mysql'
    db_host: str = '127.0.0.1'
    db_port: int = 3306
    db_username: str = 'root'
    db_password: str = 'admin1234'  # 原来为 'mysqlroot'，已改为当前真实密码
    db_database: str = 'ruoyi-fastapi'
```

- 在 `GetConfig.parse_cli_args` 中，在加载 `.env` 文件后增加一段逻辑，**强制**使用当前约定密码覆盖可能存在的旧配置：

```python
        # 统一数据库默认配置，避免被历史 .env 文件中空密码覆盖
        # 当前项目约定：开发环境使用 root/admin1234 连接 ruoyi-fastapi 库
        os.environ['DB_TYPE'] = os.environ.get('DB_TYPE', 'mysql')
        os.environ['DB_HOST'] = os.environ.get('DB_HOST', '127.0.0.1')
        os.environ['DB_PORT'] = os.environ.get('DB_PORT', '3306')
        os.environ['DB_USERNAME'] = os.environ.get('DB_USERNAME', 'root')
        # 强制覆盖为当前使用的密码，防止 .env.dev 中仍为旧密码或空密码
        os.environ['DB_PASSWORD'] = 'admin1234'
        os.environ['DB_DATABASE'] = os.environ.get('DB_DATABASE', 'ruoyi-fastapi')
```

- 再次在虚拟环境中验证：

```bash
cd ruoyi-fastapi-backend
source venv/bin/activate
python -c "from config.env import DataBaseConfig; print(DataBaseConfig.db_username, DataBaseConfig.db_password, DataBaseConfig.db_database)"
```

- 输出为：

```text
root admin1234 ruoyi-fastapi
```

说明后端已经正确读取到了与实际环境一致的数据库配置。

### 2. 修正启动脚本中的数据库连通性检查

- 修改 `start.sh` 中的数据库检查逻辑，显式使用当前密码：

```bash
# 验证数据库连接
echo -e "${BLUE}🔍 验证数据库连接...${NC}"
if ! mysql -u root -padmin1234 -e "USE \`ruoyi-fastapi\`; SELECT 1;" &> /dev/null; then
    echo -e "${RED}❌ 数据库连接失败，请先运行 ./setup.sh${NC}"
    exit 1
fi
```

- 这样一来，`./start.sh` 在检查数据库连通性时，与后端实际连接配置保持一致，不会因为缺少密码而误报“数据库连接失败”。

### 3. 确认数据库与脚本初始化一致

- 确保数据库已经按项目说明初始化完成：

```bash
mysql -u root -padmin1234 -e "CREATE DATABASE IF NOT EXISTS \`ruoyi-fastapi\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
mysql -u root -padmin1234 ruoyi-fastapi < ruoyi-fastapi-backend/sql/ruoyi-fastapi.sql
```

- 如需更新工程管理菜单，执行：

```bash
mysql -u root -padmin1234 ruoyi-fastapi < ruoyi-fastapi-backend/sql/project.sql
```

### 4. 重启后端与前端服务

- 停止已有服务（如果有）：

```bash
# 在运行 start.sh 的终端按 Ctrl + C 结束
```

- 重新启动：

```bash
cd /Users/hqz/dev/RuoYi-Vue3-FastAPI
./start.sh
```

- 启动完成后：
  - 访问前端：`http://localhost:80`
  - 刷新登录页，验证码图片可以正常加载。
  - 使用默认账号登录：
    - 用户名：`admin`
    - 密码：`admin123`

## 经验与建议

- **统一密码来源**：本地开发时，尽量只在一个地方维护数据库密码（例如统一使用 `.env.dev`），避免脚本、代码和手工习惯之间出现多处不一致。
- **修改密码后立即同步配置**：一旦修改 MySQL `root` 密码，应第一时间同步更新：
  - 后端配置（`env.py` 或 `.env.dev`）
  - 各种脚本中用到 `mysql` 命令的地方（如 `setup.sh`、`start.sh`）。
- **遇到 1045 错误时优先检查**：
  - 当前 MySQL 用户实际密码。
  - 程序运行时真正使用的配置（通过简单的 `print` 或独立脚本打印出配置对象）。

通过以上调整，当前环境下 **验证码接口和登录功能已恢复正常**，前后端都可以按 README 所描述的方式稳定启动和访问。 
