# RuoYi-FastAPI 配置实战指南与部署场景

## 文档概述

本文档提供 RuoYi-FastAPI 后端系统在不同部署场景下的实际配置示例，包括开发、测试、预发布、生产等环境的完整配置方案，以及常见部署架构的配置策略。

---

## 1. 基础部署场景配置

### 1.1 单机开发环境

**场景描述**: 开发人员本地开发环境，数据库和Redis都在本机

**配置文件**: `.env.dev`
```env
# ==================== 应用配置 ====================
APP_ENV=dev
APP_NAME=RuoYi-FastAPI-Development
APP_ROOT_PATH=/dev-api
APP_HOST=127.0.0.1
APP_PORT=9099
APP_VERSION=1.0.0-dev
APP_RELOAD=true

# ==================== 功能开关 ====================
# 开发环境允许同时登录，便于调试
APP_SAME_TIME_LOGIN=true
# 启用IP地理位置查询
APP_IP_LOCATION_QUERY=true

# ==================== JWT配置 ====================
# 开发环境使用较短的过期时间便于测试
JWT_SECRET_KEY=dev_secret_key_change_in_production_32_chars_minimum
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=720
JWT_REDIS_EXPIRE_MINUTES=30

# ==================== 数据库配置 ====================
DB_TYPE=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=123456
DB_DATABASE=ruoyi_fastapi_dev
# 开发环境启用SQL日志，便于调试
DB_ECHO=true
# 开发环境使用较小的连接池
DB_MAX_OVERFLOW=5
DB_POOL_SIZE=10
DB_POOL_RECYCLE=3600
DB_POOL_TIMEOUT=30

# ==================== Redis配置 ====================
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_USERNAME=
REDIS_PASSWORD=
# 使用独立的数据库编号避免冲突
REDIS_DATABASE=0
```

**系统配置建议**:
```sql
-- 开发环境系统配置
UPDATE sys_config SET config_value = 'false' WHERE config_key = 'sys.account.captchaEnabled';
UPDATE sys_config SET config_value = 'true' WHERE config_key = 'sys.account.registerUser';
UPDATE sys_config SET config_value = '' WHERE config_key = 'sys.login.blackIPList';
```

### 1.2 团队共享测试环境

**场景描述**: 多个开发人员共享的测试服务器环境

**配置文件**: `.env.test`
```env
# ==================== 应用配置 ====================
APP_ENV=test
APP_NAME=RuoYi-FastAPI-Test
APP_ROOT_PATH=/test-api
APP_HOST=0.0.0.0
APP_PORT=9099
APP_VERSION=1.0.0-test
# 测试环境关闭热重载提高稳定性
APP_RELOAD=false

# ==================== 功能开关 ====================
# 测试环境允许同时登录，便于多人测试
APP_SAME_TIME_LOGIN=true
APP_IP_LOCATION_QUERY=true

# ==================== JWT配置 ====================
JWT_SECRET_KEY=test_env_secret_key_should_be_different_from_dev_32_chars
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=1440
JWT_REDIS_EXPIRE_MINUTES=60

# ==================== 数据库配置 ====================
DB_TYPE=mysql
DB_HOST=test-db-server.internal
DB_PORT=3306
DB_USERNAME=test_user
DB_PASSWORD=test_secure_password
DB_DATABASE=ruoyi_fastapi_test
# 测试环境可以启用SQL日志便于问题排查
DB_ECHO=true
DB_MAX_OVERFLOW=10
DB_POOL_SIZE=20
DB_POOL_RECYCLE=3600
DB_POOL_TIMEOUT=30

# ==================== Redis配置 ====================
REDIS_HOST=test-redis-server.internal
REDIS_PORT=6379
REDIS_USERNAME=
REDIS_PASSWORD=test_redis_password
REDIS_DATABASE=1
```

### 1.3 预发布环境

**场景描述**: 与生产环境配置基本一致的预发布验证环境

**配置文件**: `.env.stage`
```env
# ==================== 应用配置 ====================
APP_ENV=stage
APP_NAME=RuoYi-FastAPI-Staging
APP_ROOT_PATH=/stage-api
APP_HOST=0.0.0.0
APP_PORT=8080
APP_VERSION=1.0.0-stage
APP_RELOAD=false

# ==================== 功能开关 ====================
# 预发布环境模拟生产环境行为
APP_SAME_TIME_LOGIN=false
APP_IP_LOCATION_QUERY=true

# ==================== JWT配置 ====================
JWT_SECRET_KEY=stage_production_like_secret_key_32_chars_minimum_length
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=480
JWT_REDIS_EXPIRE_MINUTES=30

# ==================== 数据库配置 ====================
DB_TYPE=mysql
DB_HOST=stage-db-cluster.internal
DB_PORT=3306
DB_USERNAME=stage_user
DB_PASSWORD=stage_very_secure_password
DB_DATABASE=ruoyi_fastapi_stage
# 预发布环境关闭SQL日志
DB_ECHO=false
DB_MAX_OVERFLOW=20
DB_POOL_SIZE=50
DB_POOL_RECYCLE=3600
DB_POOL_TIMEOUT=30

# ==================== Redis配置 ====================
REDIS_HOST=stage-redis-cluster.internal
REDIS_PORT=6379
REDIS_USERNAME=
REDIS_PASSWORD=stage_redis_secure_password
REDIS_DATABASE=0
```

### 1.4 生产环境

**场景描述**: 正式的生产环境，安全性和性能要求最高

**配置文件**: `.env.prod`
```env
# ==================== 应用配置 ====================
APP_ENV=prod
APP_NAME=RuoYi-FastAPI
APP_ROOT_PATH=/prod-api
APP_HOST=0.0.0.0
APP_PORT=8080
APP_VERSION=1.0.0
APP_RELOAD=false

# ==================== 功能开关 ====================
# 生产环境严格控制同时登录
APP_SAME_TIME_LOGIN=false
# 可根据需要启用或关闭IP查询（考虑外部API调用成本）
APP_IP_LOCATION_QUERY=true

# ==================== JWT配置 ====================
# 生产环境必须使用强密钥
JWT_SECRET_KEY=prod_super_secure_random_secret_key_generated_by_openssl_64_chars
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=480
JWT_REDIS_EXPIRE_MINUTES=30

# ==================== 数据库配置 ====================
DB_TYPE=mysql
DB_HOST=prod-db-cluster-primary.internal
DB_PORT=3306
DB_USERNAME=prod_app_user
DB_PASSWORD=prod_extremely_secure_password_with_special_chars
DB_DATABASE=ruoyi_fastapi_prod
# 生产环境必须关闭SQL日志
DB_ECHO=false
DB_MAX_OVERFLOW=50
DB_POOL_SIZE=100
DB_POOL_RECYCLE=3600
DB_POOL_TIMEOUT=60

# ==================== Redis配置 ====================
REDIS_HOST=prod-redis-cluster.internal
REDIS_PORT=6379
REDIS_USERNAME=prod_redis_user
REDIS_PASSWORD=prod_redis_extremely_secure_password
REDIS_DATABASE=0
```

**生产环境系统配置**:
```sql
-- 生产环境系统配置
UPDATE sys_config SET config_value = 'true' WHERE config_key = 'sys.account.captchaEnabled';
UPDATE sys_config SET config_value = 'false' WHERE config_key = 'sys.account.registerUser';
UPDATE sys_config SET config_value = 'XG9IbqNqf2010' WHERE config_key = 'sys.user.initPassword';
-- 配置生产环境IP黑名单
UPDATE sys_config SET config_value = '恶意IP列表;攻击IP段' WHERE config_key = 'sys.login.blackIPList';
```

---

## 2. 高可用部署架构配置

### 2.1 主从数据库架构

**场景描述**: 使用MySQL主从复制实现读写分离

**主库配置** (写操作):
```env
# 主数据库配置
DB_TYPE=mysql
DB_HOST=mysql-master.cluster.internal
DB_PORT=3306
DB_USERNAME=app_write_user
DB_PASSWORD=write_user_secure_password
DB_DATABASE=ruoyi_fastapi
DB_POOL_SIZE=50
DB_MAX_OVERFLOW=20
```

**从库配置** (读操作 - 需要代码层面支持):
```python
# 在代码中可以配置读写分离
class DatabaseConfig:
    WRITE_DB_URL = "mysql+asyncmy://user:pass@master-host/db"
    READ_DB_URL = "mysql+asyncmy://user:pass@slave-host/db"
```

### 2.2 Redis集群架构

**场景描述**: Redis Sentinel 或 Cluster 模式

**Redis Sentinel配置**:
```env
# 哨兵模式配置
REDIS_HOST=redis-sentinel-1.internal,redis-sentinel-2.internal,redis-sentinel-3.internal
REDIS_PORT=26379
REDIS_SENTINEL_SERVICE_NAME=mymaster
REDIS_PASSWORD=redis_cluster_password
REDIS_DATABASE=0
```

**Redis Cluster配置**:
```env
# 集群模式配置
REDIS_CLUSTER_NODES=redis-1.internal:7000,redis-2.internal:7000,redis-3.internal:7000
REDIS_PASSWORD=cluster_secure_password
REDIS_DATABASE=0
```

### 2.3 负载均衡部署

**场景描述**: 多个应用实例通过负载均衡器分发请求

**实例1配置**:
```env
APP_HOST=0.0.0.0
APP_PORT=8081
# 确保所有实例使用相同的JWT密钥
JWT_SECRET_KEY=shared_secret_key_across_all_instances
```

**实例2配置**:
```env
APP_HOST=0.0.0.0
APP_PORT=8082
# 相同的JWT密钥确保token在所有实例间有效
JWT_SECRET_KEY=shared_secret_key_across_all_instances
```

**Nginx负载均衡配置**:
```nginx
upstream ruoyi_backend {
    server app-instance-1:8081;
    server app-instance-2:8082;
    server app-instance-3:8083;
}

server {
    listen 80;
    server_name api.yourdomain.com;
    
    location /prod-api/ {
        proxy_pass http://ruoyi_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

---

## 3. 容器化部署配置

### 3.1 Docker单容器部署

**Dockerfile示例**:
```dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

# 使用环境变量控制启动参数
ENV APP_ENV=prod
EXPOSE 8080

CMD ["python", "app.py", "--env=prod"]
```

**Docker运行配置**:
```bash
docker run -d \
  --name ruoyi-fastapi \
  -p 8080:8080 \
  -e APP_ENV=prod \
  -e DB_HOST=database.internal \
  -e DB_PASSWORD=secure_password \
  -e REDIS_HOST=redis.internal \
  -e REDIS_PASSWORD=redis_password \
  -e JWT_SECRET_KEY=docker_deployment_secret_key \
  ruoyi-fastapi:latest
```

### 3.2 Docker Compose部署

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - APP_ENV=prod
      - DB_HOST=mysql
      - DB_PASSWORD=mysql_password
      - REDIS_HOST=redis
      - REDIS_PASSWORD=redis_password
    depends_on:
      - mysql
      - redis
    volumes:
      - ./uploads:/app/vf_admin/upload_path
      - ./logs:/app/logs
  
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: mysql_password
      MYSQL_DATABASE: ruoyi_fastapi
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
  
  redis:
    image: redis:7-alpine
    command: redis-server --requirepass redis_password
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  mysql_data:
  redis_data:
```

### 3.3 Kubernetes部署

**ConfigMap配置**:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: ruoyi-config
data:
  .env.prod: |
    APP_ENV=prod
    APP_NAME=RuoYi-FastAPI-K8s
    APP_ROOT_PATH=/prod-api
    APP_HOST=0.0.0.0
    APP_PORT=8080
    APP_RELOAD=false
    APP_SAME_TIME_LOGIN=false
    APP_IP_LOCATION_QUERY=true
    JWT_ALGORITHM=HS256
    JWT_EXPIRE_MINUTES=480
    JWT_REDIS_EXPIRE_MINUTES=30
    DB_TYPE=mysql
    DB_HOST=mysql-service
    DB_PORT=3306
    DB_USERNAME=app_user
    DB_DATABASE=ruoyi_fastapi
    DB_ECHO=false
    DB_POOL_SIZE=50
    REDIS_HOST=redis-service
    REDIS_PORT=6379
    REDIS_DATABASE=0
```

**Secret配置**:
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: ruoyi-secrets
type: Opaque
stringData:
  jwt-secret-key: "k8s_deployment_super_secure_secret_key_64_chars_minimum"
  db-password: "kubernetes_mysql_secure_password"
  redis-password: "kubernetes_redis_secure_password"
```

**Deployment配置**:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ruoyi-fastapi
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ruoyi-fastapi
  template:
    metadata:
      labels:
        app: ruoyi-fastapi
    spec:
      containers:
      - name: ruoyi-fastapi
        image: ruoyi-fastapi:1.0.0
        ports:
        - containerPort: 8080
        env:
        - name: JWT_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: ruoyi-secrets
              key: jwt-secret-key
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ruoyi-secrets
              key: db-password
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ruoyi-secrets
              key: redis-password
        volumeMounts:
        - name: config-volume
          mountPath: /app/.env.prod
          subPath: .env.prod
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      volumes:
      - name: config-volume
        configMap:
          name: ruoyi-config
```

---

## 4. 特殊场景配置

### 4.1 微服务架构集成

**场景描述**: 作为微服务的一部分，与其他服务集成

**服务发现配置**:
```env
# 服务注册配置
SERVICE_NAME=ruoyi-fastapi
SERVICE_VERSION=1.0.0
REGISTRY_HOST=consul.service.internal
REGISTRY_PORT=8500

# 其他服务依赖
USER_SERVICE_URL=http://user-service.internal:8080
NOTIFICATION_SERVICE_URL=http://notification-service.internal:8080
FILE_SERVICE_URL=http://file-service.internal:8080
```

### 4.2 多租户部署

**场景描述**: 同一套代码服务多个租户

**租户A配置**:
```env
APP_NAME=RuoYi-FastAPI-TenantA
APP_ROOT_PATH=/tenant-a-api
DB_DATABASE=ruoyi_fastapi_tenant_a
REDIS_DATABASE=0
JWT_SECRET_KEY=tenant_a_specific_secret_key
```

**租户B配置**:
```env
APP_NAME=RuoYi-FastAPI-TenantB
APP_ROOT_PATH=/tenant-b-api
DB_DATABASE=ruoyi_fastapi_tenant_b
REDIS_DATABASE=1
JWT_SECRET_KEY=tenant_b_specific_secret_key
```

### 4.3 跨地域部署

**场景描述**: 多个地域的数据中心部署

**北京数据中心配置**:
```env
APP_NAME=RuoYi-FastAPI-Beijing
REGION=beijing
DB_HOST=mysql-beijing.internal
REDIS_HOST=redis-beijing.internal
# 地域特定的配置
APP_IP_LOCATION_QUERY=true
TIMEZONE=Asia/Shanghai
```

**上海数据中心配置**:
```env
APP_NAME=RuoYi-FastAPI-Shanghai
REGION=shanghai
DB_HOST=mysql-shanghai.internal
REDIS_HOST=redis-shanghai.internal
TIMEZONE=Asia/Shanghai
```

---

## 5. 性能调优配置

### 5.1 高并发场景

**配置优化**:
```env
# 应用层优化
APP_SAME_TIME_LOGIN=true  # 减少Redis操作复杂度

# 数据库连接池优化
DB_POOL_SIZE=200
DB_MAX_OVERFLOW=100
DB_POOL_TIMEOUT=120

# JWT优化
JWT_EXPIRE_MINUTES=240  # 减少token刷新频率
JWT_REDIS_EXPIRE_MINUTES=60

# 禁用不必要的功能
APP_IP_LOCATION_QUERY=false  # 减少外部API调用
```

**系统配置优化**:
```sql
-- 禁用验证码减少Redis压力
UPDATE sys_config SET config_value = 'false' WHERE config_key = 'sys.account.captchaEnabled';
```

### 5.2 低资源环境

**配置优化**:
```env
# 减少资源使用
DB_POOL_SIZE=5
DB_MAX_OVERFLOW=2
DB_POOL_TIMEOUT=30

# 关闭不必要的功能
APP_IP_LOCATION_QUERY=false
DB_ECHO=false

# 增加缓存时间
JWT_EXPIRE_MINUTES=1440
JWT_REDIS_EXPIRE_MINUTES=120
```

---

## 6. 安全强化配置

### 6.1 高安全要求环境

**应用配置**:
```env
# 严格的会话控制
APP_SAME_TIME_LOGIN=false

# 短JWT过期时间
JWT_EXPIRE_MINUTES=120
JWT_REDIS_EXPIRE_MINUTES=15

# 启用所有安全功能
APP_IP_LOCATION_QUERY=true
```

**系统配置**:
```sql
-- 强制验证码
UPDATE sys_config SET config_value = 'true' WHERE config_key = 'sys.account.captchaEnabled';

-- 禁止注册
UPDATE sys_config SET config_value = 'false' WHERE config_key = 'sys.account.registerUser';

-- 复杂初始密码
UPDATE sys_config SET config_value = 'ComplexP@ssw0rd2024!' WHERE config_key = 'sys.user.initPassword';

-- 严格的IP黑名单
UPDATE sys_config SET config_value = '0.0.0.0/0;::/0' WHERE config_key = 'sys.login.blackIPList';
```

### 6.2 内网安全环境

**配置策略**:
```env
# 内网环境可以适当放宽
APP_SAME_TIME_LOGIN=true
JWT_EXPIRE_MINUTES=480

# 但仍需要基本安全措施
JWT_SECRET_KEY=internal_network_still_needs_secure_key
```

---

## 7. 监控和运维配置

### 7.1 日志集中管理

**配置示例**:
```env
# 启用详细日志
LOG_LEVEL=INFO
LOG_FORMAT=json
LOG_OUTPUT=/var/log/ruoyi-fastapi/app.log

# ELK集成
ELASTICSEARCH_HOST=elasticsearch.monitoring.internal
LOGSTASH_HOST=logstash.monitoring.internal
```

### 7.2 健康检查配置

**Kubernetes健康检查**:
```yaml
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5
```

### 7.3 指标监控配置

**Prometheus集成**:
```env
# 监控配置
METRICS_ENABLED=true
PROMETHEUS_PORT=9090
METRICS_ENDPOINT=/metrics
```

---

## 总结

本文档提供了 RuoYi-FastAPI 在各种部署场景下的完整配置方案，涵盖：

- **基础部署场景**: 开发、测试、预发布、生产环境的标准配置
- **高可用架构**: 主从数据库、Redis集群、负载均衡配置
- **容器化部署**: Docker、Docker Compose、Kubernetes配置
- **特殊场景**: 微服务、多租户、跨地域部署
- **性能调优**: 高并发和低资源环境的优化配置
- **安全强化**: 不同安全级别要求的配置方案
- **运维监控**: 日志、健康检查、监控集成配置

通过这些实战配置示例，可以快速适配各种部署需求，确保系统在不同环境下的稳定运行。

---

**文档版本**: v1.0  
**更新时间**: 2024年12月  
**维护人员**: DevOps Team