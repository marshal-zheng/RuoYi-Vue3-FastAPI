# 后端开发规范

## 代码风格

### 1. Python 代码规范

遵循 PEP 8 规范,使用 Ruff 进行代码检查和格式化。

**配置文件**: `ruff.toml`

```toml
line-length = 120
target-version = "py39"

[lint]
select = ["E", "F", "W", "I"]
ignore = ["E501"]
```

### 2. 命名规范

#### 文件命名
- 模块文件: `user_controller.py`, `user_service.py`
- 配置文件: `database.py`, `env.py`
- 工具文件: `jwt_util.py`, `redis_util.py`

#### 类命名
```python
# 使用 PascalCase (大驼峰)
class UserController:
    pass

class UserService:
    pass

class SysUser(Base):
    pass
```

#### 函数/方法命名
```python
# 使用 snake_case (下划线)
async def get_user_list():
    pass

async def add_user():
    pass

def verify_password():
    pass
```

#### 变量命名
```python
# 使用 snake_case
user_name = "admin"
page_num = 1
total_count = 100

# 常量使用大写
MAX_PAGE_SIZE = 100
DEFAULT_STATUS = "0"
```

### 3. 导入规范

```python
# 标准库导入
import os
import sys
from datetime import datetime
from typing import List, Optional

# 第三方库导入
from fastapi import APIRouter, Depends
from sqlalchemy import select
from pydantic import BaseModel

# 本地导入
from config.get_db import get_db
from module_admin.service.user_service import UserService
from utils.response_util import ResponseUtil
```

## 分层开发规范

### 1. Controller 层规范

```python
from fastapi import APIRouter, Depends, Path, Query
from module_admin.annotation.log_annotation import Log
from module_admin.aspect.interface_auth import CheckUserInterfaceAuth
from module_admin.entity.vo.user_vo import UserQueryModel, UserModel
from module_admin.service.user_service import UserService
from utils.response_util import ResponseUtil

router = APIRouter(prefix="/system/user", tags=["用户管理"])

@router.get(
    "/list",
    summary="获取用户列表",
    dependencies=[Depends(CheckUserInterfaceAuth("system:user:list"))]
)
@Log(title="用户管理", business_type=1)
async def get_user_list(
    query: UserQueryModel = Depends(),
    service: UserService = Depends()
):
    """
    获取用户列表
    
    参数:
    - query: 查询条件
    
    返回:
    - 用户列表和总数
    """
    result = await service.get_user_list(query)
    return ResponseUtil.success(data=result)
```

**规范要点**:
- 使用 `APIRouter` 定义路由
- 添加 `summary` 和文档注释
- 使用权限装饰器
- 使用日志装饰器
- 统一响应格式
- 不包含业务逻辑

### 2. Service 层规范

```python
from sqlalchemy.ext.asyncio import AsyncSession
from fastapi import Depends
from config.get_db import get_db
from module_admin.dao.user_dao import UserDao
from module_admin.entity.vo.user_vo import UserQueryModel, UserModel
from module_admin.entity.do.user_do import SysUser
from utils.pwd_util import PwdUtil
from exceptions.exception import ServiceException

class UserService:
    """
    用户服务类
    """
    
    def __init__(self, db: AsyncSession = Depends(get_db)):
        self.db = db
        self.user_dao = UserDao(db)
    
    async def get_user_list(self, query: UserQueryModel):
        """
        获取用户列表
        
        参数:
        - query: 查询条件
        
        返回:
        - 用户列表和总数
        """
        # 调用 DAO 层查询
        users = await self.user_dao.get_user_list(query)
        total = await self.user_dao.get_user_count(query)
        
        return {
            "rows": users,
            "total": total
        }
    
    async def add_user(self, user: UserModel):
        """
        新增用户
        
        参数:
        - user: 用户信息
        """
        # 业务规则验证
        existing = await self.user_dao.get_user_by_username(user.user_name)
        if existing:
            raise ServiceException(message="用户名已存在")
        
        # 密码加密
        user.password = PwdUtil.get_password_hash(user.password)
        
        # 保存用户
        user_do = SysUser(**user.dict())
        await self.user_dao.add_user(user_do)
        
        # 提交事务
        await self.db.commit()
```

**规范要点**:
- 包含业务逻辑
- 进行业务规则验证
- 调用 DAO 层操作数据
- 管理事务
- 抛出业务异常
- 添加清晰的注释

### 3. DAO 层规范

```python
from sqlalchemy import select, func, and_
from sqlalchemy.ext.asyncio import AsyncSession
from module_admin.entity.do.user_do import SysUser
from module_admin.entity.vo.user_vo import UserQueryModel

class UserDao:
    """
    用户数据访问类
    """
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def get_user_list(self, query: UserQueryModel):
        """
        查询用户列表
        
        参数:
        - query: 查询条件
        
        返回:
        - 用户列表
        """
        stmt = select(SysUser)
        
        # 构建查询条件
        conditions = []
        if query.user_name:
            conditions.append(SysUser.user_name.like(f"%{query.user_name}%"))
        if query.status:
            conditions.append(SysUser.status == query.status)
        
        if conditions:
            stmt = stmt.where(and_(*conditions))
        
        # 分页
        stmt = stmt.offset((query.page_num - 1) * query.page_size).limit(query.page_size)
        
        # 执行查询
        result = await self.db.execute(stmt)
        return result.scalars().all()
    
    async def get_user_by_username(self, username: str):
        """
        根据用户名查询用户
        
        参数:
        - username: 用户名
        
        返回:
        - 用户对象或 None
        """
        stmt = select(SysUser).where(SysUser.user_name == username)
        result = await self.db.execute(stmt)
        return result.scalar_one_or_none()
    
    async def add_user(self, user: SysUser):
        """
        新增用户
        
        参数:
        - user: 用户对象
        """
        self.db.add(user)
        await self.db.flush()
```

**规范要点**:
- 只负责数据库操作
- 使用异步查询
- 不包含业务逻辑
- 不直接提交事务
- 方法命名清晰

### 4. Entity 层规范

#### DO (Database Object)

```python
from sqlalchemy import Column, BigInteger, String, DateTime
from config.database import Base

class SysUser(Base):
    """
    用户表
    """
    __tablename__ = "sys_user"
    
    user_id = Column(BigInteger, primary_key=True, autoincrement=True, comment="用户ID")
    user_name = Column(String(30), nullable=False, comment="用户账号")
    nick_name = Column(String(30), nullable=False, comment="用户昵称")
    email = Column(String(50), comment="用户邮箱")
    phonenumber = Column(String(11), comment="手机号码")
    sex = Column(String(1), comment="用户性别")
    password = Column(String(100), comment="密码")
    status = Column(String(1), default="0", comment="帐号状态")
    create_time = Column(DateTime, comment="创建时间")
    update_time = Column(DateTime, comment="更新时间")
```

#### VO (View Object)

```python
from pydantic import BaseModel, Field
from typing import Optional
from datetime import datetime

class UserQueryModel(BaseModel):
    """
    用户查询模型
    """
    user_name: Optional[str] = Field(None, description="用户名")
    phonenumber: Optional[str] = Field(None, description="手机号")
    status: Optional[str] = Field(None, description="状态")
    dept_id: Optional[int] = Field(None, description="部门ID")
    page_num: int = Field(default=1, ge=1, description="页码")
    page_size: int = Field(default=10, ge=1, le=100, description="每页数量")

class UserModel(BaseModel):
    """
    用户模型
    """
    user_id: Optional[int] = Field(None, description="用户ID")
    user_name: str = Field(..., min_length=1, max_length=30, description="用户账号")
    nick_name: str = Field(..., min_length=1, max_length=30, description="用户昵称")
    email: Optional[str] = Field(None, max_length=50, description="邮箱")
    phonenumber: Optional[str] = Field(None, max_length=11, description="手机号")
    password: Optional[str] = Field(None, description="密码")
    status: str = Field(default="0", description="状态")
    
    class Config:
        from_attributes = True
```

## 异步编程规范

### 1. 使用 async/await

```python
# ✅ 正确
async def get_user_list(self, query: UserQueryModel):
    result = await self.db.execute(stmt)
    return result.scalars().all()

# ❌ 错误
def get_user_list(self, query: UserQueryModel):
    result = self.db.execute(stmt)  # 缺少 await
    return result.scalars().all()
```

### 2. 数据库操作必须异步

```python
# ✅ 正确
async def add_user(self, user: SysUser):
    self.db.add(user)
    await self.db.flush()
    await self.db.commit()

# ❌ 错误
def add_user(self, user: SysUser):
    self.db.add(user)
    self.db.flush()  # 缺少 await
    self.db.commit()  # 缺少 await
```

## 异常处理规范

### 1. 自定义异常

```python
from exceptions.exception import ServiceException

# 业务异常
raise ServiceException(message="用户名已存在")

# 权限异常
raise PermissionException(message="无权限访问")

# 参数异常
raise ParamException(message="参数错误")
```

### 2. 异常捕获

```python
async def add_user(self, user: UserModel):
    try:
        # 业务逻辑
        await self.user_dao.add_user(user)
        await self.db.commit()
    except ServiceException:
        # 业务异常直接抛出
        raise
    except Exception as e:
        # 其他异常回滚事务
        await self.db.rollback()
        raise ServiceException(message=f"新增用户失败: {str(e)}")
```

## 日志规范

### 1. 操作日志

```python
from module_admin.annotation.log_annotation import Log

@router.post("")
@Log(title="用户管理", business_type=2)  # 1查询 2新增 3修改 4删除
async def add_user(...):
    pass
```

### 2. 系统日志

```python
from loguru import logger

# 信息日志
logger.info(f"用户 {user_name} 登录成功")

# 警告日志
logger.warning(f"用户 {user_name} 登录失败")

# 错误日志
logger.error(f"数据库连接失败: {str(e)}")
```

## 注释规范

### 1. 模块注释

```python
"""
用户管理模块

包含用户的 CRUD 操作、角色分配、密码管理等功能
"""
```

### 2. 类注释

```python
class UserService:
    """
    用户服务类
    
    提供用户管理相关的业务逻辑处理
    """
```

### 3. 方法注释

```python
async def get_user_list(self, query: UserQueryModel):
    """
    获取用户列表
    
    参数:
    - query: 查询条件,包含用户名、状态、部门等筛选条件
    
    返回:
    - dict: 包含 rows(用户列表) 和 total(总数)
    
    异常:
    - ServiceException: 查询失败时抛出
    """
    pass
```

## 测试规范

### 1. 单元测试

```python
import pytest
from module_admin.service.user_service import UserService

@pytest.mark.asyncio
async def test_get_user_list():
    """测试获取用户列表"""
    service = UserService()
    query = UserQueryModel(page_num=1, page_size=10)
    result = await service.get_user_list(query)
    
    assert result is not None
    assert "rows" in result
    assert "total" in result
```

### 2. 集成测试

```python
from fastapi.testclient import TestClient
from server import app

client = TestClient(app)

def test_user_list_api():
    """测试用户列表接口"""
    response = client.get("/system/user/list?page_num=1&page_size=10")
    assert response.status_code == 200
    assert response.json()["code"] == 200
```

## 性能优化规范

### 1. 数据库查询优化

```python
# ✅ 使用索引字段查询
stmt = select(SysUser).where(SysUser.user_id == user_id)

# ✅ 只查询需要的字段
stmt = select(SysUser.user_id, SysUser.user_name)

# ✅ 使用分页
stmt = stmt.offset(offset).limit(limit)

# ❌ 避免查询所有数据
stmt = select(SysUser)  # 没有分页
```

### 2. 缓存使用

```python
from utils.redis_util import RedisUtil

# 查询前先从缓存获取
cache_key = f"user:{user_id}"
user = await RedisUtil.get(cache_key)

if not user:
    # 缓存不存在,查询数据库
    user = await self.user_dao.get_user_by_id(user_id)
    # 写入缓存
    await RedisUtil.set(cache_key, user, expire=3600)

return user
```

### 3. 批量操作

```python
# ✅ 批量插入
users = [SysUser(...), SysUser(...), SysUser(...)]
self.db.add_all(users)
await self.db.commit()

# ❌ 循环插入
for user_data in users_data:
    user = SysUser(**user_data)
    self.db.add(user)
    await self.db.commit()  # 每次都提交
```

## 安全规范

### 1. SQL 注入防护

```python
# ✅ 使用参数化查询
stmt = select(SysUser).where(SysUser.user_name == user_name)

# ❌ 字符串拼接
stmt = f"SELECT * FROM sys_user WHERE user_name = '{user_name}'"
```

### 2. 密码安全

```python
# ✅ 密码加密存储
user.password = PwdUtil.get_password_hash(password)

# ❌ 明文存储
user.password = password
```

### 3. 权限验证

```python
# ✅ 添加权限验证
@router.get("/list", dependencies=[Depends(CheckUserInterfaceAuth("system:user:list"))])

# ❌ 没有权限验证
@router.get("/list")
```

## Git 提交规范

### 1. 提交信息格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

### 2. Type 类型

- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建/工具相关

### 3. 示例

```
feat(user): 添加用户导出功能

- 实现用户列表导出为 Excel
- 支持按条件筛选导出
- 添加导出权限控制

Closes #123
```

## 代码审查清单

- [ ] 代码符合分层架构
- [ ] 命名规范清晰
- [ ] 添加必要注释
- [ ] 异常处理完善
- [ ] 添加权限控制
- [ ] 添加操作日志
- [ ] 数据验证完整
- [ ] 性能考虑合理
- [ ] 安全措施到位
- [ ] 测试覆盖充分

## 开发工具推荐

### 1. IDE
- PyCharm Professional
- VS Code + Python 插件

### 2. 代码质量
- Ruff (代码检查和格式化)
- Black (代码格式化)
- mypy (类型检查)

### 3. 调试工具
- FastAPI Swagger UI
- Postman
- Redis Desktop Manager

## 总结

遵循这些开发规范可以:
- 提高代码质量和可维护性
- 减少 bug 和安全隐患
- 提升团队协作效率
- 保持代码风格一致
