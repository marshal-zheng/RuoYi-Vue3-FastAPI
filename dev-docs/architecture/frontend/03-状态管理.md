# 状态管理 (Pinia)

## Pinia 简介

Pinia 是 Vue 3 的官方状态管理库,提供更简洁的 API 和更好的 TypeScript 支持。

## Store 结构

```
src/store/
├── index.ts              # Store 入口
└── modules/              # Store 模块
    ├── user.ts          # 用户状态
    ├── app.ts           # 应用状态
    ├── permission.ts    # 权限状态
    ├── settings.ts      # 设置状态
    └── tagsView.ts      # 标签页状态
```

## 用户 Store

**文件**: `src/store/modules/user.ts`

```typescript
import { defineStore } from 'pinia'
import { login, logout, getInfo } from '@/api/login'
import { getToken, setToken, removeToken } from '@/utils/auth'
import type { LoginForm, UserInfo } from '@/api/login'

interface UserState {
  token: string
  name: string
  avatar: string
  roles: string[]
  permissions: string[]
}

export const useUserStore = defineStore('user', {
  state: (): UserState => ({
    token: getToken() || '',
    name: '',
    avatar: '',
    roles: [],
    permissions: []
  }),
  
  getters: {
    // 是否已登录
    isLoggedIn: (state) => !!state.token,
    // 是否是管理员
    isAdmin: (state) => state.roles.includes('admin')
  },
  
  actions: {
    // 登录
    async login(loginForm: LoginForm) {
      const username = loginForm.username.trim()
      const password = loginForm.password
      const code = loginForm.code
      const uuid = loginForm.uuid
      
      const res = await login(username, password, code, uuid)
      setToken(res.token)
      this.token = res.token
    },
    
    // 获取用户信息
    async getInfo() {
      const res = await getInfo()
      const user = res.user
      const avatar = user.avatar || require('@/assets/images/profile.jpg')
      
      if (res.roles && res.roles.length > 0) {
        this.roles = res.roles
        this.permissions = res.permissions
      } else {
        this.roles = ['ROLE_DEFAULT']
      }
      
      this.name = user.userName
      this.avatar = avatar
      
      return res
    },
    
    // 登出
    async logout() {
      await logout()
      this.token = ''
      this.roles = []
      this.permissions = []
      removeToken()
    },
    
    // 重置 Token
    resetToken() {
      this.token = ''
      this.roles = []
      this.permissions = []
      removeToken()
    }
  }
})
```

## 权限 Store

**文件**: `src/store/modules/permission.ts`

```typescript
import { defineStore } from 'pinia'
import { constantRoutes } from '@/router'
import { getRouters } from '@/api/menu'
import Layout from '@/layout/index.vue'
import type { RouteRecordRaw } from 'vue-router'

interface PermissionState {
  routes: RouteRecordRaw[]
  addRoutes: RouteRecordRaw[]
  sidebarRouters: RouteRecordRaw[]
}

export const usePermissionStore = defineStore('permission', {
  state: (): PermissionState => ({
    routes: [],
    addRoutes: [],
    sidebarRouters: []
  }),
  
  actions: {
    // 生成路由
    async generateRoutes() {
      const res = await getRouters()
      const sdata = JSON.parse(JSON.stringify(res.data))
      const rdata = JSON.parse(JSON.stringify(res.data))
      
      const sidebarRoutes = filterAsyncRouter(sdata)
      const rewriteRoutes = filterAsyncRouter(rdata, false, true)
      
      this.addRoutes = rewriteRoutes
      this.sidebarRouters = constantRoutes.concat(sidebarRoutes)
      this.routes = constantRoutes.concat(rewriteRoutes)
      
      return rewriteRoutes
    }
  }
})

// 遍历后台传来的路由字符串,转换为组件对象
function filterAsyncRouter(asyncRouterMap: any[], lastRouter = false, type = false) {
  return asyncRouterMap.filter(route => {
    if (type && route.children) {
      route.children = filterChildren(route.children)
    }
    
    if (route.component) {
      // Layout ParentView 组件特殊处理
      if (route.component === 'Layout') {
        route.component = Layout
      } else if (route.component === 'ParentView') {
        route.component = ParentView
      } else {
        route.component = loadView(route.component)
      }
    }
    
    if (route.children != null && route.children && route.children.length) {
      route.children = filterAsyncRouter(route.children, route, type)
    } else {
      delete route['children']
      delete route['redirect']
    }
    
    return true
  })
}

// 动态加载组件
export const loadView = (view: string) => {
  return () => import(`@/views/${view}.vue`)
}
```

## 应用 Store

**文件**: `src/store/modules/app.ts`

```typescript
import { defineStore } from 'pinia'
import Cookies from 'js-cookie'

interface AppState {
  sidebar: {
    opened: boolean
    withoutAnimation: boolean
  }
  device: string
  size: string
}

export const useAppStore = defineStore('app', {
  state: (): AppState => ({
    sidebar: {
      opened: Cookies.get('sidebarStatus') !== '0',
      withoutAnimation: false
    },
    device: 'desktop',
    size: Cookies.get('size') || 'default'
  }),
  
  actions: {
    // 切换侧边栏
    toggleSideBar() {
      this.sidebar.opened = !this.sidebar.opened
      this.sidebar.withoutAnimation = false
      
      if (this.sidebar.opened) {
        Cookies.set('sidebarStatus', '1')
      } else {
        Cookies.set('sidebarStatus', '0')
      }
    },
    
    // 关闭侧边栏
    closeSideBar(withoutAnimation: boolean) {
      Cookies.set('sidebarStatus', '0')
      this.sidebar.opened = false
      this.sidebar.withoutAnimation = withoutAnimation
    },
    
    // 切换设备
    toggleDevice(device: string) {
      this.device = device
    },
    
    // 设置尺寸
    setSize(size: string) {
      this.size = size
      Cookies.set('size', size)
    }
  }
})
```

## 标签页 Store

**文件**: `src/store/modules/tagsView.ts`

```typescript
import { defineStore } from 'pinia'
import type { RouteLocationNormalized } from 'vue-router'

export interface TagView extends Partial<RouteLocationNormalized> {
  title?: string
}

interface TagsViewState {
  visitedViews: TagView[]
  cachedViews: string[]
}

export const useTagsViewStore = defineStore('tagsView', {
  state: (): TagsViewState => ({
    visitedViews: [],
    cachedViews: []
  }),
  
  actions: {
    // 添加访问的视图
    addView(view: TagView) {
      this.addVisitedView(view)
      this.addCachedView(view)
    },
    
    // 添加已访问视图
    addVisitedView(view: TagView) {
      if (this.visitedViews.some(v => v.path === view.path)) return
      
      this.visitedViews.push(
        Object.assign({}, view, {
          title: view.meta?.title || 'no-name'
        })
      )
    },
    
    // 添加缓存视图
    addCachedView(view: TagView) {
      if (this.cachedViews.includes(view.name as string)) return
      if (!view.meta?.noCache) {
        this.cachedViews.push(view.name as string)
      }
    },
    
    // 删除视图
    delView(view: TagView) {
      return new Promise(resolve => {
        this.delVisitedView(view)
        this.delCachedView(view)
        resolve({
          visitedViews: [...this.visitedViews],
          cachedViews: [...this.cachedViews]
        })
      })
    },
    
    // 删除已访问视图
    delVisitedView(view: TagView) {
      for (const [i, v] of this.visitedViews.entries()) {
        if (v.path === view.path) {
          this.visitedViews.splice(i, 1)
          break
        }
      }
    },
    
    // 删除缓存视图
    delCachedView(view: TagView) {
      const index = this.cachedViews.indexOf(view.name as string)
      index > -1 && this.cachedViews.splice(index, 1)
    },
    
    // 删除其他视图
    delOthersViews(view: TagView) {
      return new Promise(resolve => {
        this.delOthersVisitedViews(view)
        this.delOthersCachedViews(view)
        resolve({
          visitedViews: [...this.visitedViews],
          cachedViews: [...this.cachedViews]
        })
      })
    },
    
    // 删除其他已访问视图
    delOthersVisitedViews(view: TagView) {
      this.visitedViews = this.visitedViews.filter(v => {
        return v.meta?.affix || v.path === view.path
      })
    },
    
    // 删除其他缓存视图
    delOthersCachedViews(view: TagView) {
      const index = this.cachedViews.indexOf(view.name as string)
      if (index > -1) {
        this.cachedViews = this.cachedViews.slice(index, index + 1)
      } else {
        this.cachedViews = []
      }
    },
    
    // 删除所有视图
    delAllViews() {
      return new Promise(resolve => {
        this.delAllVisitedViews()
        this.delAllCachedViews()
        resolve({
          visitedViews: [...this.visitedViews],
          cachedViews: [...this.cachedViews]
        })
      })
    },
    
    // 删除所有已访问视图
    delAllVisitedViews() {
      const affixTags = this.visitedViews.filter(tag => tag.meta?.affix)
      this.visitedViews = affixTags
    },
    
    // 删除所有缓存视图
    delAllCachedViews() {
      this.cachedViews = []
    },
    
    // 更新已访问视图
    updateVisitedView(view: TagView) {
      for (let v of this.visitedViews) {
        if (v.path === view.path) {
          v = Object.assign(v, view)
          break
        }
      }
    }
  }
})
```

## 在组件中使用 Store

### 1. 基本使用

```vue
<script setup lang="ts">
import { useUserStore } from '@/store/modules/user'
import { useAppStore } from '@/store/modules/app'

// 获取 store 实例
const userStore = useUserStore()
const appStore = useAppStore()

// 访问 state
console.log(userStore.name)
console.log(appStore.device)

// 访问 getters
console.log(userStore.isLoggedIn)

// 调用 actions
userStore.logout()
appStore.toggleSideBar()
</script>
```

### 2. 解构使用

```vue
<script setup lang="ts">
import { storeToRefs } from 'pinia'
import { useUserStore } from '@/store/modules/user'

const userStore = useUserStore()

// 使用 storeToRefs 保持响应性
const { name, avatar, roles } = storeToRefs(userStore)

// actions 可以直接解构
const { logout, getInfo } = userStore
</script>
```

### 3. 在模板中使用

```vue
<template>
  <div>
    <p>用户名: {{ userStore.name }}</p>
    <p>头像: <img :src="userStore.avatar" /></p>
    <p>是否登录: {{ userStore.isLoggedIn }}</p>
    <el-button @click="userStore.logout">登出</el-button>
  </div>
</template>

<script setup lang="ts">
import { useUserStore } from '@/store/modules/user'

const userStore = useUserStore()
</script>
```

## Store 持久化

### 使用 localStorage

```typescript
import { defineStore } from 'pinia'

export const useSettingsStore = defineStore('settings', {
  state: () => ({
    theme: localStorage.getItem('theme') || 'light',
    language: localStorage.getItem('language') || 'zh-cn'
  }),
  
  actions: {
    setTheme(theme: string) {
      this.theme = theme
      localStorage.setItem('theme', theme)
    },
    
    setLanguage(language: string) {
      this.language = language
      localStorage.setItem('language', language)
    }
  }
})
```

### 使用插件

```typescript
// 安装 pinia-plugin-persistedstate
import { createPinia } from 'pinia'
import piniaPluginPersistedstate from 'pinia-plugin-persistedstate'

const pinia = createPinia()
pinia.use(piniaPluginPersistedstate)

// 在 store 中使用
export const useUserStore = defineStore('user', {
  state: () => ({
    token: '',
    userInfo: null
  }),
  
  // 开启持久化
  persist: true
})
```

## Store 组合

### 在 Store 中使用其他 Store

```typescript
import { defineStore } from 'pinia'
import { useUserStore } from './user'

export const usePermissionStore = defineStore('permission', {
  actions: {
    async generateRoutes() {
      // 使用其他 store
      const userStore = useUserStore()
      const roles = userStore.roles
      
      // 根据角色生成路由
      const accessRoutes = filterRoutes(routes, roles)
      this.routes = accessRoutes
      
      return accessRoutes
    }
  }
})
```

## 最佳实践

### 1. State 设计
- 保持 state 扁平化
- 避免嵌套过深
- 使用 TypeScript 类型定义

### 2. Actions 设计
- 一个 action 完成一个功能
- 异步操作使用 async/await
- 错误处理要完善

### 3. Getters 使用
- 用于派生状态
- 避免复杂计算
- 可以接受参数

### 4. 模块划分
- 按功能模块划分
- 保持单一职责
- 避免循环依赖

## 下一步

- [路由设计](./04-路由设计.md) - 理解路由配置
- [API集成](./05-API集成.md) - 掌握 API 调用
- [权限系统](./06-权限系统.md) - 理解权限控制
