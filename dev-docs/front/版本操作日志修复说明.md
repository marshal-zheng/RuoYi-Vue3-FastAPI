# 工程管理操作日志优化说明

## 问题描述
工程管理模块中存在以下问题：
1. 版本相关的操作（新增、编辑、删除、克隆、固化、解除固化）在操作日志中无法显示
2. 即使能显示，也无法区分是操作工程还是操作版本（都显示"工程管理"）

## 问题原因
- 前端操作日志页面 `project/operlog/index.vue` 通过 `module="工程管理"` 筛选日志
- 后端版本管理控制器 `project_version_controller.py` 中的 `@Log` 装饰器使用的 `title='项目版本管理'`
- 由于 title 不匹配，导致筛选不到版本操作的日志
- 工程操作和版本操作都使用 `title='工程管理'`，无法区分

## 修复内容

### 1. 版本管理日志优化
修改文件：`ruoyi-fastapi-backend/module_admin/controller/project_version_controller.py`

将所有版本操作的日志 title 改为 `'工程管理-版本'`：

1. **新增版本** (第54行)
```python
@Log(title='工程管理-版本', business_type=BusinessType.INSERT)
```

2. **编辑版本** (第78行)
```python
@Log(title='工程管理-版本', business_type=BusinessType.UPDATE)
```

3. **删除版本** (第100行)
```python
@Log(title='工程管理-版本', business_type=BusinessType.DELETE)
```

4. **克隆版本** (第142行)
```python
@Log(title='工程管理-版本', business_type=BusinessType.INSERT)
```

5. **固化/解除固化版本** (第164行)
```python
@Log(title='工程管理-版本', business_type=BusinessType.UPDATE)
```

6. **批量解除固化** (第191行)
```python
@Log(title='工程管理-版本', business_type=BusinessType.UPDATE)
```

### 2. 工程管理日志优化
修改文件：`ruoyi-fastapi-backend/module_admin/controller/project_controller.py`

将工程操作的日志 title 改为 `'工程管理-工程'`：

1. **新增工程** (第45行)
```python
@Log(title='工程管理-工程', business_type=BusinessType.INSERT)
```

2. **编辑工程** (第66行)
```python
@Log(title='工程管理-工程', business_type=BusinessType.UPDATE)
```

3. **删除工程** (第85行)
```python
@Log(title='工程管理-工程', business_type=BusinessType.DELETE)
```

4. **保存拓扑** (第127行)
```python
@Log(title='工程管理-拓扑', business_type=BusinessType.UPDATE)
```

### 3. 日志装饰器优化
修改文件：`ruoyi-fastapi-backend/module_admin/annotation/log_annotation.py`

在日志装饰器中添加动态判断逻辑（第185-193行）：
- 如果保存拓扑时携带了 `versionId` 参数，自动将日志标题改为 `'工程管理-版本'`
- 否则保持 `'工程管理-拓扑'`

这样就能准确记录：
- 在版本列表点击"图编辑"保存 → 记录为"修改版本"
- 在工程详情直接编辑拓扑保存 → 记录为"修改拓扑"

## 优化效果

日志列表中的"系统模块"字段将显示为：
- `工程管理-工程`：工程的新增、编辑、删除操作
- `工程管理-版本`：版本的新增、编辑、删除、克隆、固化、保存版本拓扑等操作
- `工程管理-拓扑`：工程主拓扑的保存操作（无版本关联）

这样可以清晰地区分不同类型的操作，特别是：
- **删除工程** vs **删除版本**：一目了然
- **保存版本拓扑** vs **保存工程拓扑**：自动识别

## 验证方法
1. 重启后端服务
2. 登录系统
3. 进行以下操作：
   - 新增/编辑/删除工程
   - 新增/编辑/删除版本
   - 在版本列表点击"图编辑"，修改拓扑后保存
   - 在工程详情直接编辑拓扑后保存（如果有的话）
4. 点击"工程管理" -> "操作日志"
5. 确认日志列表中能够清楚区分操作类型：
   - 删除工程：系统模块显示"工程管理-工程"
   - 删除版本：系统模块显示"工程管理-版本"
   - 编辑版本拓扑：系统模块显示"工程管理-版本"
   - 编辑工程拓扑：系统模块显示"工程管理-拓扑"

## 影响范围
- 仅影响操作日志的显示文案
- 不影响工程管理、版本管理的功能逻辑
- 不影响日志的筛选功能（仍然按"工程管理"筛选）

## 相关文件
- 前端操作日志页面：`ruoyi-fastapi-frontend/src/views/project/operlog/index.vue`
- 工程管理控制器：`ruoyi-fastapi-backend/module_admin/controller/project_controller.py`
- 版本管理控制器：`ruoyi-fastapi-backend/module_admin/controller/project_version_controller.py`
- 日志组件：`ruoyi-fastapi-frontend/src/components/business/Monitor/OperlogGrid.vue`
