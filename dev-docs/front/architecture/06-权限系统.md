# 前端权限系统

## 权限类型

### 1. 路由权限
控制用户可以访问哪些页面

### 2. 菜单权限
控制用户可以看到哪些菜单

### 3. 按钮权限
控制用户可以操作哪些按钮

### 4. 数据权限
控制用户可以看到哪些数据(后端控制)

## 路由权限

### 1. 路由守卫

**文件**: `src/permission.ts`

```typescript
import router from './router'
import { useUserStore } from '@/store/modules/user'
import { usePermissionStore } from '@/store/modules/permission'
import { ElMessage } from 'element-plus'
import NProgress from 'nprogress'
import 'nprogress/nprogress.css'
import { getToken } from '@/utils/auth'
import { isHttp } from '@/utils/validate'

NProgress.configure({ showSpinner: false })

const whiteList = ['/login', '/register']

router.beforeEach(async (to, from, next) => {
  NProgress.start()
  
  const hasToken = getToken()
  
  if (hasToken) {
    // 已登录
    if (to.path === '/login') {
      // 已登录跳转到首页
      next({ path: '/' })
      NProgress.done()
    } else {
      const userStore = useUserStore()
      const hasRoles = userStore.roles && userStore.roles.length > 0
      
      if (hasRoles) {
        // 已获取用户信息,直接访问
        next()
      } else {
        try {
          // 获取用户信息
          await userStore.getInfo()
          
          // 生成可访问的路由表
          const permissionStore = usePermissionStore()
          const accessRoutes = await permissionStore.generateRoutes()
          
          // 动态添加可访问路由
          accessRoutes.forEach(route => {
            if (!isHttp(route.path)) {
              router.addRoute(route)
            }
          })
          
          // hack方法 确保addRoutes已完成
          next({ ...to, replace: true })
        } catch (error) {
          // 移除 token 并跳转登录页
          await userStore.resetToken()
          ElMessage.error(error || 'Has Error')
          next(`/login?redirect=${to.path}`)
          NProgress.done()
        }
      }
    }
  } else {
    // 未登录
    if (whiteList.indexOf(to.path) !== -1) {
      // 在免登录白名单,直接进入
      next()
    } else {
      // 否则全部重定向到登录页
      next(`/login?redirect=${to.path}`)
      NProgress.done()
    }
  }
})

router.afterEach(() => {
  NProgress.done()
})
```

### 2. 动态路由

**文件**: `src/store/modules/permission.ts`

```typescript
import { defineStore } from 'pinia'
import { constantRoutes } from '@/router'
import { getRouters } from '@/api/menu'
import Layout from '@/layout/index.vue'
import ParentView from '@/components/ParentView/index.vue'
import type { RouteRecordRaw } from 'vue-router'

export const usePermissionStore = defineStore('permission', {
  state: () => ({
    routes: [] as RouteRecordRaw[],
    addRoutes: [] as RouteRecordRaw[],
    sidebarRouters: [] as RouteRecordRaw[]
  }),
  
  actions: {
    async generateRoutes() {
      // 向后端请求路由数据
      const res = await getRouters()
      const sdata = JSON.parse(JSON.stringify(res.data))
      const rdata = JSON.parse(JSON.stringify(res.data))
      
      // 处理路由数据
      const sidebarRoutes = filterAsyncRouter(sdata)
      const rewriteRoutes = filterAsyncRouter(rdata, false, true)
      
      // 添加404路由
      rewriteRoutes.push({ path: '/:pathMatch(.*)*', redirect: '/404', hidden: true })
      
      this.addRoutes = rewriteRoutes
      this.sidebarRouters = constantRoutes.concat(sidebarRoutes)
      this.routes = constantRoutes.concat(rewriteRoutes)
      
      return rewriteRoutes
    }
  }
})

// 遍历后台传来的路由字符串,转换为组件对象
function filterAsyncRouter(asyncRouterMap: any[], lastRouter = false, type = false): RouteRecordRaw[] {
  return asyncRouterMap.filter(route => {
    if (type && route.children) {
      route.children = filterChildren(route.children)
    }
    
    if (route.component) {
      // Layout ParentView 组件特殊处理
      if (route.component === 'Layout') {
        route.component = Layout
      } else if (route.component === 'ParentView') {
        route.component = ParentView
      } else {
        route.component = loadView(route.component)
      }
    }
    
    if (route.children != null && route.children && route.children.length) {
      route.children = filterAsyncRouter(route.children, route, type)
    } else {
      delete route['children']
      delete route['redirect']
    }
    
    return true
  })
}

function filterChildren(childrenMap: any[], lastRouter: any = false): any[] {
  let children: any[] = []
  
  childrenMap.forEach((el) => {
    if (el.children && el.children.length) {
      if (el.component === 'ParentView' && !lastRouter) {
        el.children.forEach((c: any) => {
          c.path = el.path + '/' + c.path
          if (c.children && c.children.length) {
            children = children.concat(filterChildren(c.children, c))
            return
          }
          children.push(c)
        })
        return
      }
    }
    if (lastRouter) {
      el.path = lastRouter.path + '/' + el.path
    }
    children = children.concat(el)
  })
  
  return children
}

// 动态路由遍历,验证是否具备权限
export function filterDynamicRoutes(routes: RouteRecordRaw[]) {
  const res: RouteRecordRaw[] = []
  
  routes.forEach(route => {
    if (route.permissions) {
      if (hasPermission(route.permissions)) {
        res.push(route)
      }
    } else if (route.roles) {
      if (hasRole(route.roles)) {
        res.push(route)
      }
    }
  })
  
  return res
}

// 动态加载组件
export const loadView = (view: string) => {
  return () => import(`@/views/${view}.vue`)
}
```

## 按钮权限

### 1. 权限指令

**文件**: `src/directive/permission/hasPermi.ts`

```typescript
import type { Directive, DirectiveBinding } from 'vue'
import { useUserStore } from '@/store/modules/user'

/**
 * 操作权限处理
 * v-hasPermi="['system:user:add']"
 */
export const hasPermi: Directive = {
  mounted(el: HTMLElement, binding: DirectiveBinding) {
    const { value } = binding
    const all_permission = '*:*:*'
    const permissions = useUserStore().permissions
    
    if (value && value instanceof Array && value.length > 0) {
      const permissionFlag = value
      
      const hasPermissions = permissions.some((permission: string) => {
        return all_permission === permission || permissionFlag.includes(permission)
      })
      
      if (!hasPermissions) {
        el.parentNode && el.parentNode.removeChild(el)
      }
    } else {
      throw new Error('请设置操作权限标签值')
    }
  }
}
```

**文件**: `src/directive/permission/hasRole.ts`

```typescript
import type { Directive, DirectiveBinding } from 'vue'
import { useUserStore } from '@/store/modules/user'

/**
 * 角色权限处理
 * v-hasRole="['admin']"
 */
export const hasRole: Directive = {
  mounted(el: HTMLElement, binding: DirectiveBinding) {
    const { value } = binding
    const super_admin = 'admin'
    const roles = useUserStore().roles
    
    if (value && value instanceof Array && value.length > 0) {
      const roleFlag = value
      
      const hasRole = roles.some((role: string) => {
        return super_admin === role || roleFlag.includes(role)
      })
      
      if (!hasRole) {
        el.parentNode && el.parentNode.removeChild(el)
      }
    } else {
      throw new Error('请设置角色权限标签值')
    }
  }
}
```

### 2. 注册指令

**文件**: `src/directive/permission/index.ts`

```typescript
import { hasPermi } from './hasPermi'
import { hasRole } from './hasRole'
import type { App } from 'vue'

export function setupPermissionDirective(app: App) {
  app.directive('hasPermi', hasPermi)
  app.directive('hasRole', hasRole)
}
```

**文件**: `src/main.ts`

```typescript
import { createApp } from 'vue'
import App from './App.vue'
import { setupPermissionDirective } from './directive/permission'

const app = createApp(App)

// 注册权限指令
setupPermissionDirective(app)

app.mount('#app')
```

### 3. 使用权限指令

```vue
<template>
  <div>
    <!-- 按钮权限 -->
    <el-button
      type="primary"
      icon="Plus"
      @click="handleAdd"
      v-hasPermi="['system:user:add']"
    >新增</el-button>
    
    <el-button
      type="success"
      icon="Edit"
      @click="handleUpdate"
      v-hasPermi="['system:user:edit']"
    >修改</el-button>
    
    <el-button
      type="danger"
      icon="Delete"
      @click="handleDelete"
      v-hasPermi="['system:user:remove']"
    >删除</el-button>
    
    <!-- 角色权限 -->
    <el-button
      type="warning"
      v-hasRole="['admin']"
    >管理员可见</el-button>
    
    <!-- 多个权限(满足其一即可) -->
    <el-button
      v-hasPermi="['system:user:edit', 'system:user:add']"
    >编辑或新增</el-button>
  </div>
</template>
```

## 权限工具函数

### 1. 权限检查函数

**文件**: `src/utils/permission.ts`

```typescript
import { useUserStore } from '@/store/modules/user'

/**
 * 字符权限校验
 * @param value 权限标识数组
 * @returns 是否有权限
 */
export function checkPermi(value: string[]): boolean {
  if (value && value instanceof Array && value.length > 0) {
    const permissions = useUserStore().permissions
    const permissionDatas = value
    const all_permission = '*:*:*'
    
    const hasPermission = permissions.some((permission: string) => {
      return all_permission === permission || permissionDatas.includes(permission)
    })
    
    return hasPermission
  } else {
    console.error('need roles! Like checkPermi(["system:user:add"])')
    return false
  }
}

/**
 * 角色权限校验
 * @param value 角色标识数组
 * @returns 是否有权限
 */
export function checkRole(value: string[]): boolean {
  if (value && value instanceof Array && value.length > 0) {
    const roles = useUserStore().roles
    const permissionRoles = value
    const super_admin = 'admin'
    
    const hasRole = roles.some((role: string) => {
      return super_admin === role || permissionRoles.includes(role)
    })
    
    return hasRole
  } else {
    console.error('need roles! Like checkRole(["admin"])')
    return false
  }
}
```

### 2. 在代码中使用

```vue
<script setup lang="ts">
import { checkPermi, checkRole } from '@/utils/permission'

// 检查权限
const hasAddPermission = checkPermi(['system:user:add'])
const hasEditPermission = checkPermi(['system:user:edit'])

// 检查角色
const isAdmin = checkRole(['admin'])

// 根据权限执行不同逻辑
const handleOperation = () => {
  if (hasEditPermission) {
    // 有编辑权限
    console.log('可以编辑')
  } else {
    ElMessage.warning('无编辑权限')
  }
}
</script>
```

## 菜单权限

### 1. 侧边栏菜单

**文件**: `src/layout/components/Sidebar/index.vue`

```vue
<template>
  <div class="sidebar-container">
    <el-scrollbar>
      <el-menu
        :default-active="activeMenu"
        :collapse="isCollapse"
        :unique-opened="false"
        :collapse-transition="false"
        mode="vertical"
      >
        <sidebar-item
          v-for="route in sidebarRouters"
          :key="route.path"
          :item="route"
          :base-path="route.path"
        />
      </el-menu>
    </el-scrollbar>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { useRoute } from 'vue-router'
import { useAppStore } from '@/store/modules/app'
import { usePermissionStore } from '@/store/modules/permission'
import SidebarItem from './SidebarItem.vue'

const route = useRoute()
const appStore = useAppStore()
const permissionStore = usePermissionStore()

// 侧边栏路由(根据权限过滤)
const sidebarRouters = computed(() => permissionStore.sidebarRouters)

// 是否折叠
const isCollapse = computed(() => !appStore.sidebar.opened)

// 当前激活菜单
const activeMenu = computed(() => {
  const { meta, path } = route
  if (meta.activeMenu) {
    return meta.activeMenu
  }
  return path
})
</script>
```

### 2. 菜单项组件

**文件**: `src/layout/components/Sidebar/SidebarItem.vue`

```vue
<template>
  <div v-if="!item.hidden">
    <!-- 只有一个子菜单且不总是显示根菜单 -->
    <template v-if="hasOneShowingChild(item.children, item) && (!onlyOneChild.children || onlyOneChild.noShowingChildren) && !item.alwaysShow">
      <app-link v-if="onlyOneChild.meta" :to="resolvePath(onlyOneChild.path)">
        <el-menu-item :index="resolvePath(onlyOneChild.path)">
          <svg-icon v-if="onlyOneChild.meta.icon" :icon-class="onlyOneChild.meta.icon" />
          <template #title>
            <span>{{ onlyOneChild.meta.title }}</span>
          </template>
        </el-menu-item>
      </app-link>
    </template>
    
    <!-- 有多个子菜单 -->
    <el-sub-menu v-else :index="resolvePath(item.path)">
      <template #title>
        <svg-icon v-if="item.meta && item.meta.icon" :icon-class="item.meta.icon" />
        <span>{{ item.meta.title }}</span>
      </template>
      
      <sidebar-item
        v-for="child in item.children"
        :key="child.path"
        :item="child"
        :base-path="resolvePath(child.path)"
      />
    </el-sub-menu>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { isExternal } from '@/utils/validate'
import AppLink from './Link.vue'
import type { RouteRecordRaw } from 'vue-router'

interface Props {
  item: RouteRecordRaw
  basePath?: string
}

const props = withDefaults(defineProps<Props>(), {
  basePath: ''
})

const onlyOneChild = ref<any>(null)

// 判断是否只有一个显示的子菜单
const hasOneShowingChild = (children: RouteRecordRaw[] = [], parent: RouteRecordRaw) => {
  const showingChildren = children.filter(item => {
    if (item.hidden) {
      return false
    } else {
      onlyOneChild.value = item
      return true
    }
  })
  
  if (showingChildren.length === 1) {
    return true
  }
  
  if (showingChildren.length === 0) {
    onlyOneChild.value = { ...parent, path: '', noShowingChildren: true }
    return true
  }
  
  return false
}

// 解析路径
const resolvePath = (routePath: string) => {
  if (isExternal(routePath)) {
    return routePath
  }
  if (isExternal(props.basePath)) {
    return props.basePath
  }
  return props.basePath + '/' + routePath
}
</script>
```

## 权限配置

### 1. 后端返回的菜单数据格式

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "name": "System",
      "path": "/system",
      "hidden": false,
      "redirect": "noRedirect",
      "component": "Layout",
      "alwaysShow": true,
      "meta": {
        "title": "系统管理",
        "icon": "system",
        "noCache": false
      },
      "children": [
        {
          "name": "User",
          "path": "user",
          "hidden": false,
          "component": "system/user/index",
          "meta": {
            "title": "用户管理",
            "icon": "user",
            "noCache": false
          }
        },
        {
          "name": "Role",
          "path": "role",
          "hidden": false,
          "component": "system/role/index",
          "meta": {
            "title": "角色管理",
            "icon": "peoples",
            "noCache": false
          }
        }
      ]
    }
  ]
}
```

### 2. 权限标识配置

在菜单管理中配置权限标识:
- `system:user:list` - 用户列表查询
- `system:user:query` - 用户详情查询
- `system:user:add` - 用户新增
- `system:user:edit` - 用户修改
- `system:user:remove` - 用户删除

## 最佳实践

### 1. 权限粒度
- 页面级权限通过路由控制
- 功能级权限通过按钮控制
- 数据级权限通过后端控制

### 2. 权限缓存
- 用户权限信息缓存在 Store
- 路由权限信息缓存在 Store
- 登出时清除权限缓存

### 3. 权限更新
- 角色权限变更后需要重新登录
- 或者提供刷新权限的接口

### 4. 权限测试
- 测试不同角色的访问权限
- 测试按钮显示隐藏
- 测试路由跳转限制

## 下一步

- [开发规范](./07-开发规范.md) - 编码标准和最佳实践
