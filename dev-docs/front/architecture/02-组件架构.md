# 组件架构

## 组件分类

### 1. 页面组件 (Views)
位于 `src/views/`,对应路由的页面级组件。

### 2. 布局组件 (Layout)
位于 `src/layout/`,定义页面整体布局结构。

### 3. 业务组件 (Business Components)
位于 `src/components/business/`,封装特定业务逻辑的组件。

### 4. 通用组件 (Common Components)
位于 `src/components/`,可复用的通用 UI 组件。

## Vue 3 组合式 API

### 1. 基本语法

```vue
<template>
  <div class="user-list">
    <el-table :data="userList" @selection-change="handleSelectionChange">
      <el-table-column type="selection" width="55" />
      <el-table-column prop="userName" label="用户名" />
      <el-table-column prop="nickName" label="昵称" />
    </el-table>
    
    <pagination
      v-show="total > 0"
      :total="total"
      v-model:page="queryParams.pageNum"
      v-model:limit="queryParams.pageSize"
      @pagination="getList"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { listUser } from '@/api/system/user'
import type { UserQuery, UserVO } from '@/api/system/user'

// 响应式数据
const userList = ref<UserVO[]>([])
const total = ref(0)
const loading = ref(false)

// 查询参数
const queryParams = reactive<UserQuery>({
  pageNum: 1,
  pageSize: 10,
  userName: undefined,
  status: undefined
})

// 获取列表
const getList = async () => {
  loading.value = true
  try {
    const res = await listUser(queryParams)
    userList.value = res.rows
    total.value = res.total
  } finally {
    loading.value = false
  }
}

// 选择变化
const handleSelectionChange = (selection: UserVO[]) => {
  console.log('选中:', selection)
}

// 组件挂载
onMounted(() => {
  getList()
})
</script>

<style scoped lang="scss">
.user-list {
  padding: 20px;
}
</style>
```

### 2. 组合式函数 (Composables)

将可复用的逻辑提取为组合式函数:

```typescript
// src/composables/useTable.ts
import { ref, reactive } from 'vue'

export function useTable<T = any>(fetchFn: Function) {
  const loading = ref(false)
  const dataList = ref<T[]>([])
  const total = ref(0)
  
  const queryParams = reactive({
    pageNum: 1,
    pageSize: 10
  })
  
  const getList = async () => {
    loading.value = true
    try {
      const res = await fetchFn(queryParams)
      dataList.value = res.rows
      total.value = res.total
    } finally {
      loading.value = false
    }
  }
  
  const handleQuery = () => {
    queryParams.pageNum = 1
    getList()
  }
  
  const resetQuery = () => {
    Object.assign(queryParams, {
      pageNum: 1,
      pageSize: 10
    })
    getList()
  }
  
  return {
    loading,
    dataList,
    total,
    queryParams,
    getList,
    handleQuery,
    resetQuery
  }
}
```

使用组合式函数:

```vue
<script setup lang="ts">
import { useTable } from '@/composables/useTable'
import { listUser } from '@/api/system/user'

const {
  loading,
  dataList: userList,
  total,
  queryParams,
  getList,
  handleQuery,
  resetQuery
} = useTable(listUser)

onMounted(() => {
  getList()
})
</script>
```

## 页面组件开发

### 1. 列表页面

```vue
<template>
  <div class="app-container">
    <!-- 搜索栏 -->
    <el-form :model="queryParams" ref="queryFormRef" :inline="true">
      <el-form-item label="用户名" prop="userName">
        <el-input
          v-model="queryParams.userName"
          placeholder="请输入用户名"
          clearable
          @keyup.enter="handleQuery"
        />
      </el-form-item>
      <el-form-item label="状态" prop="status">
        <el-select v-model="queryParams.status" placeholder="用户状态" clearable>
          <el-option label="正常" value="0" />
          <el-option label="停用" value="1" />
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" icon="Search" @click="handleQuery">搜索</el-button>
        <el-button icon="Refresh" @click="resetQuery">重置</el-button>
      </el-form-item>
    </el-form>

    <!-- 操作按钮 -->
    <el-row :gutter="10" class="mb8">
      <el-col :span="1.5">
        <el-button
          type="primary"
          icon="Plus"
          @click="handleAdd"
          v-hasPermi="['system:user:add']"
        >新增</el-button>
      </el-col>
      <el-col :span="1.5">
        <el-button
          type="danger"
          icon="Delete"
          :disabled="multiple"
          @click="handleDelete"
          v-hasPermi="['system:user:remove']"
        >删除</el-button>
      </el-col>
    </el-row>

    <!-- 数据表格 -->
    <el-table
      v-loading="loading"
      :data="userList"
      @selection-change="handleSelectionChange"
    >
      <el-table-column type="selection" width="55" align="center" />
      <el-table-column label="用户编号" align="center" prop="userId" />
      <el-table-column label="用户名称" align="center" prop="userName" />
      <el-table-column label="用户昵称" align="center" prop="nickName" />
      <el-table-column label="状态" align="center">
        <template #default="scope">
          <dict-tag :options="sys_normal_disable" :value="scope.row.status" />
        </template>
      </el-table-column>
      <el-table-column label="创建时间" align="center" prop="createTime" width="180" />
      <el-table-column label="操作" align="center" class-name="small-padding fixed-width">
        <template #default="scope">
          <el-button
            link
            type="primary"
            icon="Edit"
            @click="handleUpdate(scope.row)"
            v-hasPermi="['system:user:edit']"
          >修改</el-button>
          <el-button
            link
            type="primary"
            icon="Delete"
            @click="handleDelete(scope.row)"
            v-hasPermi="['system:user:remove']"
          >删除</el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- 分页 -->
    <pagination
      v-show="total > 0"
      :total="total"
      v-model:page="queryParams.pageNum"
      v-model:limit="queryParams.pageSize"
      @pagination="getList"
    />

    <!-- 添加或修改对话框 -->
    <el-dialog :title="title" v-model="open" width="600px" append-to-body>
      <el-form ref="userFormRef" :model="form" :rules="rules" label-width="80px">
        <el-form-item label="用户名称" prop="userName">
          <el-input v-model="form.userName" placeholder="请输入用户名称" />
        </el-form-item>
        <el-form-item label="用户昵称" prop="nickName">
          <el-input v-model="form.nickName" placeholder="请输入用户昵称" />
        </el-form-item>
        <el-form-item label="手机号码" prop="phonenumber">
          <el-input v-model="form.phonenumber" placeholder="请输入手机号码" maxlength="11" />
        </el-form-item>
        <el-form-item label="邮箱" prop="email">
          <el-input v-model="form.email" placeholder="请输入邮箱" maxlength="50" />
        </el-form-item>
        <el-form-item label="状态">
          <el-radio-group v-model="form.status">
            <el-radio label="0">正常</el-radio>
            <el-radio label="1">停用</el-radio>
          </el-radio-group>
        </el-form-item>
      </el-form>
      <template #footer>
        <div class="dialog-footer">
          <el-button type="primary" @click="submitForm">确 定</el-button>
          <el-button @click="cancel">取 消</el-button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts" name="User">
import { ref, reactive, onMounted } from 'vue'
import { listUser, getUser, addUser, updateUser, delUser } from '@/api/system/user'
import type { UserQuery, UserForm, UserVO } from '@/api/system/user'
import { ElMessage, ElMessageBox } from 'element-plus'

// 数据
const userList = ref<UserVO[]>([])
const total = ref(0)
const loading = ref(false)
const open = ref(false)
const title = ref('')
const multiple = ref(true)
const ids = ref<number[]>([])

// 查询参数
const queryParams = reactive<UserQuery>({
  pageNum: 1,
  pageSize: 10,
  userName: undefined,
  status: undefined
})

// 表单数据
const form = ref<UserForm>({})

// 表单校验
const rules = {
  userName: [{ required: true, message: '用户名称不能为空', trigger: 'blur' }],
  nickName: [{ required: true, message: '用户昵称不能为空', trigger: 'blur' }],
  password: [{ required: true, message: '用户密码不能为空', trigger: 'blur' }]
}

// 获取列表
const getList = async () => {
  loading.value = true
  try {
    const res = await listUser(queryParams)
    userList.value = res.rows
    total.value = res.total
  } finally {
    loading.value = false
  }
}

// 搜索
const handleQuery = () => {
  queryParams.pageNum = 1
  getList()
}

// 重置
const resetQuery = () => {
  queryFormRef.value?.resetFields()
  handleQuery()
}

// 多选框选中数据
const handleSelectionChange = (selection: UserVO[]) => {
  ids.value = selection.map(item => item.userId)
  multiple.value = !selection.length
}

// 新增
const handleAdd = () => {
  reset()
  open.value = true
  title.value = '添加用户'
}

// 修改
const handleUpdate = async (row: UserVO) => {
  reset()
  const userId = row.userId
  const res = await getUser(userId)
  form.value = res.data
  open.value = true
  title.value = '修改用户'
}

// 提交
const submitForm = () => {
  userFormRef.value?.validate(async (valid: boolean) => {
    if (valid) {
      if (form.value.userId) {
        await updateUser(form.value)
        ElMessage.success('修改成功')
      } else {
        await addUser(form.value)
        ElMessage.success('新增成功')
      }
      open.value = false
      getList()
    }
  })
}

// 删除
const handleDelete = (row?: UserVO) => {
  const userIds = row?.userId ? [row.userId] : ids.value
  ElMessageBox.confirm('是否确认删除用户编号为"' + userIds + '"的数据项?', '警告', {
    confirmButtonText: '确定',
    cancelButtonText: '取消',
    type: 'warning'
  }).then(async () => {
    await delUser(userIds)
    ElMessage.success('删除成功')
    getList()
  })
}

// 取消
const cancel = () => {
  open.value = false
  reset()
}

// 重置表单
const reset = () => {
  form.value = {
    userId: undefined,
    userName: undefined,
    nickName: undefined,
    password: undefined,
    phonenumber: undefined,
    email: undefined,
    sex: '0',
    status: '0'
  }
  userFormRef.value?.resetFields()
}

onMounted(() => {
  getList()
})
</script>
```

### 2. 详情页面

```vue
<template>
  <div class="app-container">
    <el-card v-loading="loading">
      <template #header>
        <div class="card-header">
          <span>用户详情</span>
          <el-button type="primary" @click="handleEdit">编辑</el-button>
        </div>
      </template>
      
      <el-descriptions :column="2" border>
        <el-descriptions-item label="用户名">{{ userInfo.userName }}</el-descriptions-item>
        <el-descriptions-item label="用户昵称">{{ userInfo.nickName }}</el-descriptions-item>
        <el-descriptions-item label="手机号码">{{ userInfo.phonenumber }}</el-descriptions-item>
        <el-descriptions-item label="用户邮箱">{{ userInfo.email }}</el-descriptions-item>
        <el-descriptions-item label="用户性别">
          <dict-tag :options="sys_user_sex" :value="userInfo.sex" />
        </el-descriptions-item>
        <el-descriptions-item label="帐号状态">
          <dict-tag :options="sys_normal_disable" :value="userInfo.status" />
        </el-descriptions-item>
        <el-descriptions-item label="创建时间">{{ userInfo.createTime }}</el-descriptions-item>
        <el-descriptions-item label="更新时间">{{ userInfo.updateTime }}</el-descriptions-item>
      </el-descriptions>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { getUser } from '@/api/system/user'
import type { UserVO } from '@/api/system/user'

const route = useRoute()
const router = useRouter()

const loading = ref(false)
const userInfo = ref<UserVO>({})

const getUserInfo = async () => {
  loading.value = true
  try {
    const userId = route.params.id as string
    const res = await getUser(parseInt(userId))
    userInfo.value = res.data
  } finally {
    loading.value = false
  }
}

const handleEdit = () => {
  router.push(`/system/user/edit/${userInfo.value.userId}`)
}

onMounted(() => {
  getUserInfo()
})
</script>
```

## 业务组件开发

### 1. 协议表单组件

```vue
<template>
  <el-drawer
    v-model="visible"
    :title="title"
    size="60%"
    @close="handleClose"
  >
    <el-form ref="formRef" :model="form" :rules="rules" label-width="120px">
      <el-form-item label="协议名称" prop="protocolName">
        <el-input v-model="form.protocolName" placeholder="请输入协议名称" />
      </el-form-item>
      
      <el-form-item label="协议类型" prop="protocolType">
        <protocol-type-selector v-model="form.protocolType" @change="handleTypeChange" />
      </el-form-item>
      
      <!-- 根据协议类型显示不同的配置模板 -->
      <ethernet-protocol-template
        v-if="form.protocolType === 'ethernet'"
        v-model="form.configData"
      />
      
      <can-protocol-template
        v-else-if="form.protocolType === 'can'"
        v-model="form.configData"
      />
      
      <rs422-protocol-template
        v-else-if="form.protocolType === 'rs422'"
        v-model="form.configData"
      />
    </el-form>
    
    <template #footer>
      <el-button @click="handleClose">取消</el-button>
      <el-button type="primary" @click="handleSubmit">确定</el-button>
    </template>
  </el-drawer>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import ProtocolTypeSelector from './selector/ProtocolTypeSelector.vue'
import EthernetProtocolTemplate from './templates/EthernetProtocolTemplate.vue'
import CanProtocolTemplate from './templates/CANProtocolTemplate.vue'
import Rs422ProtocolTemplate from './templates/RS422ProtocolTemplate.vue'
import type { ProtocolForm } from '@/api/protocol/protocol'

interface Props {
  modelValue: boolean
  data?: ProtocolForm
}

const props = withDefaults(defineProps<Props>(), {
  modelValue: false,
  data: undefined
})

const emit = defineEmits(['update:modelValue', 'success'])

const visible = computed({
  get: () => props.modelValue,
  set: (val) => emit('update:modelValue', val)
})

const title = computed(() => props.data ? '编辑协议' : '新增协议')

const form = ref<ProtocolForm>({
  protocolName: '',
  protocolType: '',
  configData: {}
})

const rules = {
  protocolName: [{ required: true, message: '请输入协议名称', trigger: 'blur' }],
  protocolType: [{ required: true, message: '请选择协议类型', trigger: 'change' }]
}

const handleTypeChange = (type: string) => {
  // 切换协议类型时重置配置数据
  form.value.configData = {}
}

const handleSubmit = () => {
  formRef.value?.validate((valid: boolean) => {
    if (valid) {
      emit('success', form.value)
      handleClose()
    }
  })
}

const handleClose = () => {
  visible.value = false
  formRef.value?.resetFields()
}

// 监听 props.data 变化,初始化表单
watch(() => props.data, (val) => {
  if (val) {
    form.value = { ...val }
  }
}, { immediate: true })
</script>
```

## 通用组件开发

### 1. 分页组件

```vue
<template>
  <div class="pagination-container">
    <el-pagination
      v-model:current-page="currentPage"
      v-model:page-size="pageSize"
      :page-sizes="pageSizes"
      :total="total"
      :background="background"
      :layout="layout"
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
    />
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'

interface Props {
  total: number
  page?: number
  limit?: number
  pageSizes?: number[]
  layout?: string
  background?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  page: 1,
  limit: 10,
  pageSizes: () => [10, 20, 30, 50],
  layout: 'total, sizes, prev, pager, next, jumper',
  background: true
})

const emit = defineEmits(['update:page', 'update:limit', 'pagination'])

const currentPage = computed({
  get: () => props.page,
  set: (val) => emit('update:page', val)
})

const pageSize = computed({
  get: () => props.limit,
  set: (val) => emit('update:limit', val)
})

const handleSizeChange = (val: number) => {
  emit('pagination', { page: currentPage.value, limit: val })
}

const handleCurrentChange = (val: number) => {
  emit('pagination', { page: val, limit: pageSize.value })
}
</script>

<style scoped lang="scss">
.pagination-container {
  padding: 20px 0;
  text-align: right;
}
</style>
```

### 2. 字典标签组件

```vue
<template>
  <span v-if="values.length > 0">
    <template v-for="(item, index) in values" :key="item.value">
      <span v-if="item.raw && item.raw.listClass === 'default'" :class="item.raw.cssClass">
        {{ item.label + ' ' }}
      </span>
      <el-tag
        v-else
        :type="item.raw && item.raw.listClass === 'primary' ? '' : item.raw?.listClass"
        :class="item.raw?.cssClass"
      >
        {{ item.label + ' ' }}
      </el-tag>
    </template>
  </span>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import type { DictDataOption } from '@/utils/dict'

interface Props {
  options: DictDataOption[]
  value: string | number | Array<string | number>
}

const props = defineProps<Props>()

const values = computed(() => {
  if (props.value === null || props.value === undefined || props.value === '') {
    return []
  }
  
  const valueArray = Array.isArray(props.value) ? props.value : [String(props.value)]
  
  return valueArray.map(val => {
    const option = props.options.find(item => String(item.value) === String(val))
    return {
      value: val,
      label: option?.label || val,
      raw: option
    }
  })
})
</script>
```

## 组件通信

### 1. Props / Emits

```vue
<!-- 父组件 -->
<template>
  <user-form
    v-model:visible="dialogVisible"
    :user-id="currentUserId"
    @success="handleSuccess"
  />
</template>

<!-- 子组件 -->
<script setup lang="ts">
interface Props {
  visible: boolean
  userId?: number
}

const props = defineProps<Props>()
const emit = defineEmits(['update:visible', 'success'])

const handleSubmit = () => {
  // 提交成功后触发事件
  emit('success')
  emit('update:visible', false)
}
</script>
```

### 2. Provide / Inject

```vue
<!-- 祖先组件 -->
<script setup lang="ts">
import { provide, ref } from 'vue'

const theme = ref('light')
provide('theme', theme)
</script>

<!-- 后代组件 -->
<script setup lang="ts">
import { inject } from 'vue'

const theme = inject('theme')
</script>
```

### 3. Pinia Store

```typescript
// store/modules/user.ts
import { defineStore } from 'pinia'

export const useUserStore = defineStore('user', {
  state: () => ({
    userInfo: null
  }),
  actions: {
    setUserInfo(info: any) {
      this.userInfo = info
    }
  }
})

// 组件中使用
import { useUserStore } from '@/store/modules/user'

const userStore = useUserStore()
userStore.setUserInfo(info)
```

## 下一步

- [状态管理](./03-状态管理.md) - 学习 Pinia 使用
- [路由设计](./04-路由设计.md) - 理解路由配置
- [API集成](./05-API集成.md) - 掌握 API 调用
