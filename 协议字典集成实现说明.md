# 协议字典集成实现说明

## 概述

本次实现将协议管理功能中的硬编码字段改造为使用系统字典管理，提升了系统的可维护性和用户体验。

## 实现内容

### 1. 数据库字典初始化 (SQL)

**文件**: `ruoyi-fastapi-backend/sql/protocol_dict_data.sql`

创建了10个字典类型和相应的字典数据：

1. **协议类型** (`sys_protocol_type`)
   - 以太网 (ethernet)
   - RS422 (rs422)
   - CAN (can)
   - 1553B (1553b)

2. **传输频率** (`sys_protocol_frequency`)
   - 单次、10ms、20ms、50ms、100ms、160ms、200ms、500ms、1000ms

3. **传输速率** (按协议类型分类)
   - 以太网: 10M、100M、1000M
   - RS422: 9.6K ~ 921.6K (8个选项)
   - CAN: 125K、250K、500K、1000K
   - 1553B: 1M

4. **传输方式**
   - 以太网: UDP单播、UDP组播、UDP广播、TCP
   - CAN: CAN标准帧、CAN扩展帧

5. **数据类型** (`sys_protocol_data_type`)
   - uint8, uint16, uint32, int8, int16, int32, float, double, string, bool

6. **错误处理** (`sys_protocol_error_handling`)
   - 不判断、超时重传、CRC校验、奇偶校验等

### 2. 通用字典选择器组件

**文件**: `ruoyi-fastapi-frontend/src/components/DictSelect/index.vue`

创建了一个可复用的字典选择器组件，特性：
- 支持通过 `dict-type` 属性指定字典类型
- 自动从后端API加载字典数据
- 支持单选/多选、可清空、可搜索等配置
- 支持字典项的样式类（list_class）显示
- 提供刷新和获取标签的方法

### 3. 协议类型选择器更新

**文件**: `ruoyi-fastapi-frontend/src/components/business/Protocol/selector/ProtocolTypeSelector.vue`

- 移除硬编码的协议类型选项
- 使用 `DictSelect` 组件从字典加载数据
- 保持原有的接口和事件不变

### 4. 协议模板组件更新

更新了所有4个协议模板组件，使其使用字典数据：

#### 以太网协议模板
**文件**: `ruoyi-fastapi-frontend/src/components/business/Protocol/templates/EthernetProtocolTemplate.vue`

- 传输频率：使用 `sys_protocol_frequency` 字典
- 传输速率：使用 `sys_protocol_speed_ethernet` 字典
- 传输方式：使用 `sys_protocol_method_ethernet` 字典
- 错误处理：使用 `sys_protocol_error_handling` 字典
- 数据类型：使用 `sys_protocol_data_type` 字典

#### RS422协议模板
**文件**: `ruoyi-fastapi-frontend/src/components/business/Protocol/templates/RS422ProtocolTemplate.vue`

- 传输频率：使用 `sys_protocol_frequency` 字典
- 传输速率：使用 `sys_protocol_speed_rs422` 字典
- 错误处理：使用 `sys_protocol_error_handling` 字典
- 数据类型：使用 `sys_protocol_data_type` 字典
- 传输方式：固定为 "RS422"

#### CAN协议模板
**文件**: `ruoyi-fastapi-frontend/src/components/business/Protocol/templates/CANProtocolTemplate.vue`

- 传输频率：使用 `sys_protocol_frequency` 字典
- 传输速率：使用 `sys_protocol_speed_can` 字典
- 传输方式：使用 `sys_protocol_method_can` 字典
- 错误处理：使用 `sys_protocol_error_handling` 字典
- 数据类型：使用 `sys_protocol_data_type` 字典

#### 1553B协议模板
**文件**: `ruoyi-fastapi-frontend/src/components/business/Protocol/templates/Protocol1553BTemplate.vue`

- 传输频率：使用 `sys_protocol_frequency` 字典
- 错误处理：使用 `sys_protocol_error_handling` 字典
- 数据类型：使用 `sys_protocol_data_type` 字典
- 传输速率：固定为 "1M"
- 传输方式：固定为 "1553B"

## 部署步骤

### 1. 执行SQL脚本

```bash
# 连接到数据库
mysql -u root -p ruoyi-fastapi

# 执行字典数据初始化脚本
source ruoyi-fastapi-backend/sql/protocol_dict_data.sql
```

### 2. 刷新字典缓存

登录系统后，进入 **系统管理 > 字典管理**，点击"刷新缓存"按钮，确保字典数据加载到Redis。

### 3. 前端部署

```bash
cd ruoyi-fastapi-frontend
yarn install
yarn build:prod
```

## 数据迁移说明

### 现有协议数据兼容性

**注意**：由于字典值从中文改为英文代码（如"以太网" -> "ethernet"），如果系统中已有协议数据，需要进行数据迁移：

```sql
-- 更新协议类型字段
UPDATE sys_protocol SET protocol_type = 'ethernet' WHERE protocol_type = '以太网';
UPDATE sys_protocol SET protocol_type = 'rs422' WHERE protocol_type = 'RS422';
UPDATE sys_protocol SET protocol_type = 'can' WHERE protocol_type = 'CAN';
UPDATE sys_protocol SET protocol_type = '1553b' WHERE protocol_type = '1553B';
```

**如果是全新系统**，无需执行上述迁移脚本。

### 协议配置JSON数据迁移

需要更新 `protocol_config` JSON字段中的值：

```sql
-- 这需要根据实际数据结构编写迁移脚本
-- 示例：更新传输频率
UPDATE sys_protocol 
SET protocol_config = JSON_SET(
  protocol_config,
  '$.frequency', 
  CASE JSON_EXTRACT(protocol_config, '$.frequency')
    WHEN '单次' THEN 'once'
    WHEN '10ms' THEN '10'
    WHEN '100ms' THEN '100'
    -- 添加其他映射...
  END
)
WHERE protocol_config IS NOT NULL;
```

## SQL文件组织说明

### 最终采用的方案

经过评估，采用了**混合策略**：

1. **主SQL文件集成** (`ruoyi-fastapi.sql`)
   - 将所有协议字典数据合并到主初始化文件中
   - 放在系统字典数据之后，使用ID范围 100-199
   - 新系统部署时一次性初始化，不会遗漏

2. **增量更新脚本** (`update_protocol_dict.sql`)
   - 保留独立的增量更新脚本
   - 用于已部署系统的数据更新
   - 使用 `WHERE NOT EXISTS` 避免重复插入

### 为什么这样做？

**字典数据的特殊性**：
- 系统核心依赖：字典在系统启动时加载到Redis缓存
- 全局共享：跨模块使用的基础数据
- 与系统字典（用户性别、系统状态等）性质相同

**优势**：
- ✅ 新环境部署：一个SQL文件完成所有初始化
- ✅ 已有环境：使用增量脚本安全更新
- ✅ 数据完整性：不会因遗漏执行某个SQL而导致功能异常
- ✅ 维护便利：字典数据集中管理，便于查看和修改

## 优势

1. **可维护性提升**：协议类型、速率等配置项可通过字典管理界面修改，无需修改代码
2. **用户体验改善**：下拉选择替代手动输入，减少输入错误
3. **数据一致性**：统一使用字典值，避免数据不一致
4. **扩展性增强**：新增协议类型或配置项只需添加字典数据
5. **国际化支持**：字典标签可以根据语言切换显示不同文本
6. **部署简化**：新系统只需执行主SQL文件即可

## 注意事项

1. **字典ID范围**：使用了100-199的ID范围，避免与系统默认字典冲突
2. **默认值标记**：部分常用选项标记为默认值（is_default='Y'）
3. **样式类**：为状态类字典项配置了list_class，用于显示不同颜色
4. **向后兼容**：建议保留旧数据一段时间，确保迁移完全成功后再清理

## 后续优化建议

1. **批量导入**：提供Excel模板，支持批量导入协议配置
2. **字典版本管理**：记录字典修改历史，支持回滚
3. **字典权限控制**：限制普通用户修改核心字典数据
4. **多语言支持**：为字典标签添加多语言翻译
5. **字典依赖关系**：建立字典间的依赖关系，如协议类型变化时自动更新可选速率
