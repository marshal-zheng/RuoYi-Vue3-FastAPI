# 协议管理功能实现说明

## 功能概述

协议管理功能用于管理系统中的通信协议配置，支持多种协议类型（以太网、RS422、CAN、1553B），提供协议的增删改查、版本固化等功能。

## 实现架构

### 后端实现

#### 1. 数据库层
- **表结构**: `sys_protocol` - 协议管理表
- **SQL文件**: 
  - `ruoyi-fastapi-backend/sql/sys_protocol.sql` - 表结构和测试数据
  - `ruoyi-fastapi-backend/sql/protocol_menu.sql` - 菜单权限配置

#### 2. 数据模型层
- **DO (Database Object)**: `protocol_do.py` - 数据库实体模型
- **VO (View Object)**: `protocol_vo.py` - 视图对象模型
  - `ProtocolModel` - 协议基础模型
  - `ProtocolQueryModel` - 查询模型
  - `ProtocolPageQueryModel` - 分页查询模型
  - `DeleteProtocolModel` - 删除模型
  - `LockProtocolModel` - 固化/解除固化模型

#### 3. 数据访问层 (DAO)
- **文件**: `protocol_dao.py`
- **主要方法**:
  - `get_protocol_detail_by_id` - 根据ID获取协议详情
  - `get_protocol_list` - 获取协议列表（支持分页和筛选）
  - `add_protocol_dao` - 新增协议
  - `edit_protocol_dao` - 编辑协议
  - `delete_protocol_dao` - 删除协议
  - `lock_protocol_dao` - 固化/解除固化协议

#### 4. 业务逻辑层 (Service)
- **文件**: `protocol_service.py`
- **主要方法**:
  - `get_protocol_list_services` - 获取协议列表
  - `add_protocol_services` - 新增协议
  - `edit_protocol_services` - 编辑协议（包含固化状态检查）
  - `delete_protocol_services` - 删除协议（包含固化状态检查）
  - `protocol_detail_services` - 获取协议详情
  - `lock_protocol_services` - 固化/解除固化协议

#### 5. 控制器层 (Controller)
- **文件**: `protocol_controller.py`
- **API端点**:
  - `GET /system/protocol/list` - 获取协议列表
  - `POST /system/protocol` - 新增协议
  - `PUT /system/protocol` - 编辑协议
  - `DELETE /system/protocol/{protocol_ids}` - 删除协议
  - `GET /system/protocol/{protocol_id}` - 获取协议详情
  - `PUT /system/protocol/lock` - 固化/解除固化协议

### 前端实现

#### 1. API层
- **文件**: `src/api/protocol/protocol.js`
- **方法**: 封装所有协议相关的HTTP请求

#### 2. 业务组件层
**目录**: `src/components/business/Protocol/`

- **ProtocolTypeSelector.vue** - 协议类型选择器
- **ProtocolFormDrawer.vue** - 协议表单抽屉组件
- **templates/** - 协议配置模板组件
  - `EthernetProtocolTemplate.vue` - 以太网协议配置
  - `RS422ProtocolTemplate.vue` - RS422协议配置
  - `CANProtocolTemplate.vue` - CAN协议配置
  - `Protocol1553BTemplate.vue` - 1553B协议配置

#### 3. 视图层
- **文件**: `src/views/protocol/index.vue`
- **功能**:
  - 使用 ZxGridList 组件实现列表展示
  - 支持搜索、筛选、分页
  - 支持新增、编辑、删除、固化操作
  - 集成权限控制

## 核心功能

### 1. 协议列表管理
- 分页展示协议列表
- 支持按协议名称搜索
- 支持按协议类型筛选
- 支持按创建时间范围筛选
- 显示协议状态和固化状态

### 2. 协议新增/编辑
- 使用抽屉式表单
- 基本信息配置：名称、类型、版本、描述
- 根据协议类型动态显示配置模板
- 表单验证

### 3. 协议固化管理
- 固化后的协议不可修改和删除
- 支持解除固化
- 固化状态可视化标识

### 4. 权限控制
- `protocol:list` - 查看协议列表
- `protocol:query` - 查询协议详情
- `protocol:add` - 新增协议
- `protocol:edit` - 编辑协议
- `protocol:remove` - 删除协议
- `protocol:export` - 导出协议

## 数据库表结构

```sql
CREATE TABLE `sys_protocol` (
  `protocol_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '协议ID',
  `protocol_name` varchar(100) NOT NULL COMMENT '协议名称',
  `protocol_type` varchar(50) NOT NULL COMMENT '协议类型',
  `version` varchar(50) NOT NULL COMMENT '版本号',
  `status` char(1) NOT NULL DEFAULT '0' COMMENT '状态（0正常 1停用）',
  `is_locked` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否固化',
  `description` varchar(500) DEFAULT NULL COMMENT '协议描述',
  `protocol_config` json DEFAULT NULL COMMENT '协议配置',
  `create_by` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_by` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `del_flag` char(1) DEFAULT '0' COMMENT '删除标志',
  PRIMARY KEY (`protocol_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='协议管理表';
```

## 部署步骤

### 1. 数据库初始化
```bash
# 创建协议表
mysql -u root -p ruoyi-fastapi < ruoyi-fastapi-backend/sql/sys_protocol.sql

# 添加菜单权限
mysql -u root -p ruoyi-fastapi < ruoyi-fastapi-backend/sql/protocol_menu.sql
```

### 2. 后端启动
后端代码已自动注册到 `server.py`，无需额外配置。

### 3. 前端访问
访问路径：`/protocol/list`

## 技术特点

1. **组件化设计**: 业务组件与视图分离，提高代码复用性
2. **类型安全**: 使用 Pydantic 模型确保数据类型安全
3. **权限控制**: 完整的 RBAC 权限控制
4. **用户体验**: 使用 ZxGridList 提供流畅的列表交互体验
5. **扩展性**: 协议配置模板支持动态扩展新的协议类型

## 注意事项

1. 固化的协议无法修改和删除，需先解除固化
2. 协议配置使用 JSON 格式存储，支持灵活的配置结构
3. 删除操作为逻辑删除，数据不会真正从数据库中移除
4. 协议类型选择器可根据实际需求扩展更多协议类型

## 后续优化建议

1. 添加协议导入导出功能
2. 添加协议版本历史记录
3. 添加协议配置校验规则
4. 添加协议使用情况统计
5. 支持协议模板的自定义配置
