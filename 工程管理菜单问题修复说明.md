# 工程管理菜单问题修复说明

## 问题描述

在工程管理模块中添加了"操作日志"子菜单，并将原来的二级菜单改名为"工程列表"，但是：

1. **菜单管理功能中看不到这些菜单** - 因为菜单数据只存在于运行时数据库中，没有同步到SQL初始化文件
2. **数据库重新初始化后菜单会丢失** - 因为主SQL文件（`ruoyi-fastapi.sql`）中没有包含工程管理的菜单数据
3. **菜单ID不固定** - 原来的 `sys_project.sql` 使用了 `LAST_INSERT_ID()`，导致每次执行菜单ID都不同

## 问题根源

工程管理模块的菜单数据通过 `sys_project.sql` 单独添加，使用了动态ID生成：

```sql
SET @parentId = LAST_INSERT_ID();
```

这种方式在单独执行时可以工作，但有以下问题：
- 菜单ID不固定，每次执行可能不同
- 没有包含在主SQL文件中，重新初始化数据库时会丢失
- 与其他模块的菜单ID可能冲突

## 解决方案

### 1. 更新主SQL文件

已将工程管理菜单添加到 `ruoyi-fastapi-backend/sql/ruoyi-fastapi.sql` 中：

**一级菜单：**
- ID=4: 工程管理

**二级菜单：**
- ID=118: 工程列表
- ID=119: 操作日志（复用系统监控的操作日志页面）

**按钮权限：**
- ID=1061: 工程查询
- ID=1062: 工程新增
- ID=1063: 工程修改
- ID=1064: 工程删除

### 2. 提供独立模块脚本

新增 `ruoyi-fastapi-backend/sql/project.sql`，将工程表结构、项目版本示例数据以及菜单/权限补丁全部收敛在一个脚本中，方便按需执行。

### 3. 自动清理旧数据

`project.sql` 内部包含幂等逻辑，会清理旧的随机菜单 ID，重新插入固定 ID 菜单并恢复管理员角色权限，无需额外的临时脚本。

## 执行步骤

### 方案A：更新现有数据库（推荐）

如果你的数据库已经在运行，执行更新脚本：

```bash
mysql -u root -p ruoyi-fastapi < ruoyi-fastapi-backend/sql/project.sql
```

### 方案B：重新初始化数据库

如果可以重新初始化数据库（会丢失所有数据）：

```bash
# 1. 删除旧数据库
mysql -u root -p -e "DROP DATABASE IF EXISTS \`ruoyi-fastapi\`;"

# 2. 创建新数据库
mysql -u root -p -e "CREATE DATABASE \`ruoyi-fastapi\` CHARACTER SET utf8mb4;"

# 3. 导入主SQL文件（已包含工程管理菜单）
mysql -u root -p ruoyi-fastapi < ruoyi-fastapi-backend/sql/ruoyi-fastapi.sql

# 4. 导入工程管理表结构（只执行表结构部分，跳过菜单部分）
mysql -u root -p ruoyi-fastapi -e "
DROP TABLE IF EXISTS \`sys_project\`;
CREATE TABLE \`sys_project\` (
  \`project_id\` int(11) NOT NULL AUTO_INCREMENT COMMENT '工程编号',
  \`project_desc\` text COMMENT '工程描述',
  \`create_by\` varchar(64) DEFAULT '' COMMENT '创建人',
  \`create_time\` datetime DEFAULT NULL COMMENT '创建时间',
  \`update_by\` varchar(64) DEFAULT '' COMMENT '更新者',
  \`update_time\` datetime DEFAULT NULL COMMENT '更新时间',
  \`del_flag\` char(1) DEFAULT '0' COMMENT '删除标志（0代表存在 2代表删除）',
  PRIMARY KEY (\`project_id\`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4 COMMENT='工程管理表';
"

# 5. 导入工程/版本模块
mysql -u root -p ruoyi-fastapi < ruoyi-fastapi-backend/sql/project.sql
```

## 验证步骤

执行更新后，验证菜单是否正确：

1. **登录系统**
   - 使用 admin/admin123 登录

2. **检查菜单管理**
   - 进入：系统管理 → 菜单管理
   - 应该能看到"工程管理"一级菜单（ID=4）
   - 展开后应该能看到：
     - 工程列表（ID=118）
     - 操作日志（ID=119）
   - 展开"工程列表"应该能看到4个按钮权限（1061-1064）

3. **检查左侧菜单**
   - 左侧导航应该显示"工程管理"菜单
   - 点击展开应该显示：
     - 工程列表
     - 操作日志

4. **测试功能**
   - 点击"工程列表"，应该能正常访问工程管理页面
   - 点击"操作日志"，应该能看到系统操作日志（包括工程管理的操作）

## 菜单结构

```
工程管理 (ID=4, 一级菜单)
├── 工程列表 (ID=118, 二级菜单)
│   ├── 工程查询 (ID=1061, 按钮)
│   ├── 工程新增 (ID=1062, 按钮)
│   ├── 工程修改 (ID=1063, 按钮)
│   └── 工程删除 (ID=1064, 按钮)
└── 操作日志 (ID=119, 二级菜单)
    └── 复用系统监控的操作日志页面
```

## 注意事项

1. **操作日志是复用的**
   - "工程管理 → 操作日志"复用的是"系统管理 → 日志管理 → 操作日志"的页面
   - 权限标识是 `monitor:operlog:list`
   - 显示的是全系统的操作日志，不仅仅是工程管理的

2. **菜单ID固定**
   - 工程管理相关菜单使用固定ID（4, 118, 119, 1061-1064）
   - 不要手动修改这些ID，以保持与SQL文件一致

3. **权限配置**
   - admin角色默认拥有所有权限
   - 其他角色需要在"角色管理"中分配工程管理权限

4. **数据库兼容性**
   - SQL脚本同时支持MySQL和PostgreSQL
   - 使用 `sysdate()` 函数获取当前时间

## 相关文件

- `ruoyi-fastapi-backend/sql/ruoyi-fastapi.sql` - 主 SQL 文件（已更新）
- `ruoyi-fastapi-backend/sql/project.sql` - 工程管理/项目版本/菜单补丁脚本

## 常见问题

### Q1: 执行更新脚本后还是看不到菜单？

A: 检查以下几点：
1. 确认SQL执行成功，没有报错
2. 清除浏览器缓存，重新登录
3. 检查角色权限，确保当前用户有工程管理权限
4. 查看菜单数据是否存在：
   ```bash
   mysql -u root -p ruoyi-fastapi -e "SELECT menu_id, menu_name, parent_id, perms FROM sys_menu WHERE menu_id IN (4,118,119,1061,1062,1063,1064) ORDER BY menu_id;"
   ```

### Q2: 菜单ID冲突怎么办？

A: 如果数据库中已经有ID=4或118-119的菜单：
1. 先备份数据库
2. 手动删除冲突的菜单
3. 再执行更新脚本

### Q3: 操作日志显示的不是工程管理的日志？

A: 这是正常的，因为"工程管理 → 操作日志"复用的是系统级别的操作日志页面，显示的是全系统的操作日志。如果需要只显示工程管理的日志，需要：
1. 创建独立的工程操作日志页面
2. 修改菜单的 component 路径
3. 在页面中添加过滤条件

## 总结

通过这次修复：
1. ✅ 菜单数据已同步到主SQL文件
2. ✅ 菜单ID固定，不会再变化
3. ✅ 菜单管理功能中可以看到工程管理菜单
4. ✅ 数据库重新初始化后菜单不会丢失
5. ✅ 二级菜单名称已更新为"工程列表"
6. ✅ 添加了"操作日志"子菜单
